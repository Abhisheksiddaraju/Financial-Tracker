<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Tracker v2.2 - Local App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #718096;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab:hover {
            color: #4a5568;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.3s;
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        label {
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .transaction-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .sortable-header:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1) !important;
        }
        
        .sort-indicator {
            margin-left: 8px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sortable-header:active {
            transform: scale(0.98);
        }
        
        .sortable-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .sortable-header:hover::after {
            opacity: 1;
        }
        
        .transaction-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .transaction-table tr:hover {
            background: #f7fafc;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .summary-card:hover {
            transform: scale(1.05);
        }
        
        .summary-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .positive { color: #48bb78; }
        .negative { color: #f56565; }
        
        .allocation-positive { color: #48bb78; }
        .allocation-negative { color: #f56565; }
        
        .export-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 10px;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
        }
        
        .mortgage-result {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .result-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .data-controls {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        
        .version-info {
            text-align: center;
            color: #718096;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .chart-container {
            margin: 20px 0;
            text-align: center;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            height: 400px;
            position: relative;
        }
        
        .chart-container canvas {
            max-width: 100%;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>💰 Personal Financial Tracker v2.2</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('monthly')">Monthly Budget</button>
            <button class="tab" onclick="switchTab('transactions')">Transactions</button>
            <button class="tab" onclick="switchTab('etf-transactions')">ETF Portfolio</button>
            <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('analytics')">Analytics</button>
        </div>
        
        <!-- Monthly Budget Tab -->
        <div id="monthly" class="tab-content active">
            <div class="section">
                <h2>Bank Account Balance</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>Starting Balance (€)</label>
                        <input type="number" id="startingBalance" placeholder="0" step="0.01" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Balance as of Date</label>
                        <input type="date" id="balanceAsOfDate" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Current Balance (€)</label>
                        <input type="number" id="currentBalance" placeholder="0" readonly style="background-color: #f7fafc;">
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <label>Balance Status</label>
                        <div id="balanceStatus" style="padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; background-color: #f7fafc; border: 2px solid #e2e8f0;">
                            No Transactions
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Balance Change</label>
                        <div id="balanceChange" style="padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; background-color: #f7fafc; border: 2px solid #e2e8f0;">
                            €0.00
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Income</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>Salary (After Tax)</label>
                        <input type="number" id="salary" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Other Income</label>
                        <input type="number" id="otherIncome" placeholder="0" onchange="updateSummary()">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Monthly Budget Categories</h2>
                <p style="color: #718096; margin-bottom: 20px; font-style: italic;">
                    Set your monthly budget for each spending category. The dashboard will show how much you're over/under budget.
                </p>
                <div class="input-group">
                    <div class="input-field">
                        <label>Rent/Housing</label>
                        <input type="number" id="budgetRent" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Utilities</label>
                        <input type="number" id="budgetUtilities" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Groceries</label>
                        <input type="number" id="budgetGroceries" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Eating Out</label>
                        <input type="number" id="budgetEatingOut" placeholder="0" onchange="updateSummary()">
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <label>Transportation</label>
                        <input type="number" id="budgetTransportation" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Entertainment</label>
                        <input type="number" id="budgetEntertainment" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Shopping</label>
                        <input type="number" id="budgetShopping" placeholder="0" onchange="updateSummary()">
                    </div>
                    <div class="input-field">
                        <label>Hobbies</label>
                        <input type="number" id="budgetHobbies" placeholder="0" onchange="updateSummary()">
                    </div>
                </div>
                <div class="input-group">
                     <div class="input-field">
                         <label>Internet/Phone</label>
                         <input type="number" id="budgetInternet" placeholder="0" onchange="updateSummary()">
                     </div>
                     <div class="input-field">
                         <label>Insurance</label>
                         <input type="number" id="budgetInsurance" placeholder="0" onchange="updateSummary()">
                     </div>
                     <div class="input-field">
                         <label>ETF Investment</label>
                         <input type="number" id="budgetETFInvestment" placeholder="0" onchange="updateSummary()">
                     </div>
                     <div class="input-field">
                         <label>Miscellaneous</label>
                         <input type="number" id="budgetMisc" placeholder="0" onchange="updateSummary()">
                     </div>
                 </div>
                
                <!-- Total Monthly Budget Display -->
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; text-align: center; color: white;">
                      <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">Total Monthly Budget</h3>
                      <div style="font-size: 2em; font-weight: bold;" id="totalMonthlyBudget">€0.00</div>
                      <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.9em;">Sum of all budget categories above</p>
                  </div>
                  
                <!-- ETF Portfolio Status -->
                <div style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                      <h3 style="margin: 0 0 15px 0; color: #2d3748;">ETF Portfolio Status</h3>
                      <div class="input-group">
                          <div class="input-field">
                              <label>Current Total Portfolio Value (€)</label>
                              <input type="number" id="currentTotalPortfolio" placeholder="0" readonly style="background-color: #f7fafc;">
                          </div>
                          <div class="input-field">
                              <label>Monthly Growth Rate (%)</label>
                              <input type="number" id="monthlyGrowthRate" placeholder="0" readonly style="background-color: #f7fafc;">
                          </div>
                      </div>
                      <p style="color: #718096; margin-top: 15px; font-style: italic;">
                          💡 <strong>Tip:</strong> Use the ETF Portfolio tab to record your portfolio values by date. The app will automatically calculate growth rates.
                      </p>
                </div>
            </div>
        </div>
        
        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="section">
                <h2>Add Transaction</h2>
                <p style="color: #718096; margin-bottom: 20px; font-style: italic;">
                    💡 <strong>Tip:</strong> Click on any column header to sort transactions. Click again to reverse the sort order.
                </p>
                <div class="input-group">
                    <div class="input-field">
                        <label>Date</label>
                        <input type="date" id="transDate" step="1">
                    </div>
                    <div class="input-field">
                        <label>Description</label>
                        <input type="text" id="transDesc" placeholder="e.g., Grocery shopping">
                    </div>
                    <div class="input-field">
                        <label>Category</label>
                        <select id="transCategory">
                            <option>Income</option>
                            <option>Rent/Housing</option>
                            <option>Utilities</option>
                            <option>Groceries</option>
                            <option>Transportation</option>
                            <option>Entertainment</option>
                            <option>Shopping</option>
                            <option>Savings</option>
                            <option>ETF Investment</option>
                            <option>Eating Out</option>
                            <option>Internet/Phone</option>
                            <option>Hobbies</option>
                            <option>Miscellaneous</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="input-field">
                        <label>Amount</label>
                        <input type="number" id="transAmount" placeholder="0">
                    </div>
                    <div class="input-field">
                        <label>Payment Method</label>
                        <select id="transPaymentMethod">
                            <option>Card</option>
                            <option>PayPal</option>
                            <option>Bank Transfer</option>
                            <option>Cash</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTransaction()">Add Transaction</button>
                
                <!-- Transaction Filtering Controls -->
                <div style="margin: 20px 0; padding: 15px; background: #f0f4f8; border-radius: 8px; border: 1px solid #d1d5db;">
                    <h3 style="margin: 0 0 15px 0; color: #374151; font-size: 1.1em;">📅 Transaction Filters</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563;">View Month</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn" style="padding: 6px 10px; background: #667eea; color: white; font-size: 12px;" onclick="changeTransactionMonth(-1)">◀</button>
                                <select id="transactionMonthSelector" onchange="filterTransactionsByMonth()" style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <!-- Options populated by JavaScript -->
                                </select>
                                <button class="btn" style="padding: 6px 10px; background: #667eea; color: white; font-size: 12px;" onclick="changeTransactionMonth(1)">▶</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563;">Filter by Category</label>
                            <select id="transactionCategoryFilter" onchange="filterTransactionsByMonth()" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                <option value="all">All Categories</option>
                                <option value="Income">Income</option>
                                <option value="Rent/Housing">Rent/Housing</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Groceries">Groceries</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Savings">Savings</option>
                                <option value="ETF Investment">ETF Investment</option>
                                <option value="Eating Out">Eating Out</option>
                                <option value="Internet/Phone">Internet/Phone</option>
                                <option value="Hobbies">Hobbies</option>
                                <option value="Miscellaneous">Miscellaneous</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563;">Actions</label>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn" style="padding: 6px 12px; background: #48bb78; color: white; font-size: 12px;" onclick="resetTransactionFilters()">🔄 All Time</button>
                                <button class="btn" style="padding: 6px 12px; background: #764ba2; color: white; font-size: 12px;" onclick="exportTransactionMonth()">📄 Export</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Filtered Transactions:</strong> <span id="transactionCount">0</span>
                        </div>
                        <div>
                            <strong>Total Income:</strong> <span id="transactionTotalIncome" class="positive">€0.00</span>
                        </div>
                        <div>
                            <strong>Total Expenses:</strong> <span id="transactionTotalExpenses" class="negative">€0.00</span>
                        </div>
                        <div>
                            <strong>Net Amount:</strong> <span id="transactionNetAmount">€0.00</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        <span id="transactionFilterStatus">Showing all transactions</span>
                    </div>
                </div>
                
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="sortTransactions('date')">
                                Date
                                <span class="sort-indicator" id="sort-date">▼</span>
                            </th>
                            <th class="sortable-header" onclick="sortTransactions('desc')">
                                Description
                                <span class="sort-indicator" id="sort-desc">-</span>
                            </th>
                            <th class="sortable-header" onclick="sortTransactions('category')">
                                Category
                                <span class="sort-indicator" id="sort-category">-</span>
                            </th>
                            <th class="sortable-header" onclick="sortTransactions('amount')">
                                Amount
                                <span class="sort-indicator" id="sort-amount">-</span>
                            </th>
                            <th class="sortable-header" onclick="sortTransactions('paymentMethod')">
                                Payment Method
                                <span class="sort-indicator" id="sort-paymentMethod">-</span>
                            </th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList"></tbody>
                </table>
            </div>
        </div>
        
        <!-- ETF Transactions Tab -->
        <div id="etf-transactions" class="tab-content">
            <div class="section">
                <h2>Add ETF Portfolio Value</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>Date</label>
                        <input type="date" id="etfDate" step="1">
                    </div>
                    <div class="input-field">
                        <label>Portfolio Value (€)</label>
                        <input type="number" id="etfValue" placeholder="0" step="0.01">
                    </div>
                    <div class="input-field">
                        <label>Notes (Optional)</label>
                        <input type="text" id="etfNotes" placeholder="e.g., Monthly check-in, market dip">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addETFTransaction()">Add Portfolio Value</button>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Total Entries:</strong> <span id="etfEntryCount">0</span>
                        </div>
                        <div>
                            <strong>Latest Value:</strong> <span id="latestETFValue" class="positive">€0.00</span>
                        </div>
                        <div>
                            <strong>Total Growth:</strong> <span id="totalETFGrowth">€0.00</span>
                        </div>
                        <div>
                            <strong>Growth Rate:</strong> <span id="overallGrowthRate">0.00%</span>
                        </div>
                    </div>
                </div>
                
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Portfolio Value (€)</th>
                            <th>Change (€)</th>
                            <th>Growth Rate (%)</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="etfTransactionList"></tbody>
                </table>
            </div>
        </div>
        
                          <!-- Dashboard Tab -->
          <div id="dashboard" class="tab-content">

              <!-- Month Navigation & Comparison Controls -->
              <div class="section">
                  <h2>📅 Dashboard Controls</h2>
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 20px;">
                      <div>
                          <label style="display: block; margin-bottom: 8px; font-weight: 600;">📊 Current View Month</label>
                          <div style="display: flex; align-items: center; gap: 10px;">
                              <button class="btn" style="padding: 8px 12px; background: #667eea; color: white;" onclick="changeMonth(-1)">◀ Prev</button>
                              <select id="monthSelector" onchange="selectMonth()" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                                  <!-- Options will be populated by JavaScript -->
                              </select>
                              <button class="btn" style="padding: 8px 12px; background: #667eea; color: white;" onclick="changeMonth(1)">Next ▶</button>
                          </div>
                      </div>
                      <div>
                          <label style="display: block; margin-bottom: 8px; font-weight: 600;">🔍 Comparison Mode</label>
                          <div style="display: flex; align-items: center; gap: 10px;">
                              <button class="btn" id="toggleComparison" style="padding: 8px 16px; background: #48bb78; color: white; border-radius: 8px;" onclick="toggleComparisonMode()">
                                  Enable Comparison
                              </button>
                              <select id="compareMonthSelector" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; display: none;" onchange="updateComparison()">
                                  <!-- Options will be populated by JavaScript -->
                              </select>
                          </div>
                      </div>
                      <div>
                          <label style="display: block; margin-bottom: 8px; font-weight: 600;">📈 View Options</label>
                          <div style="display: flex; gap: 10px;">
                              <button class="btn" style="padding: 8px 12px; background: #764ba2; color: white; font-size: 12px;" onclick="exportMonthlyReport()">📄 Export Report</button>
                              <button class="btn" style="padding: 8px 12px; background: #667eea; color: white; font-size: 12px;" onclick="resetToCurrentMonth()">🔄 Current Month</button>
                          </div>
                          <div id="analyticsStatus" style="margin-top: 8px; font-size: 11px; color: #6b7280; display: none;">
                              📊 Analytics available with <span id="analyticsMonthsNeeded">3</span> months of data
                          </div>
                      </div>
                  </div>
                  
                  <!-- Month Comparison Display -->
                  <div id="comparisonSummary" style="display: none; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 15px;">
                      <h3 style="margin: 0 0 15px 0; color: #2d3748;">📊 Month Comparison Summary</h3>
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                          <div>
                              <div style="font-weight: bold; color: #4a5568; margin-bottom: 8px;" id="currentMonthLabel">Current Month</div>
                              <div style="font-size: 1.2em; color: #2d3748;" id="currentMonthData">€0</div>
                          </div>
                          <div>
                              <div style="font-weight: bold; color: #4a5568; margin-bottom: 8px;">Difference</div>
                              <div style="font-size: 1.2em; font-weight: bold;" id="monthDifference">€0</div>
                          </div>
                          <div>
                              <div style="font-weight: bold; color: #4a5568; margin-bottom: 8px;" id="compareMonthLabel">Compare Month</div>
                              <div style="font-size: 1.2em; color: #2d3748;" id="compareMonthData">€0</div>
                          </div>
                      </div>
                  </div>
              </div>
             
              <div class="section">
                  <h2>Total Budget vs Total Expenses</h2>
                  <div class="chart-container">
                      <canvas id="totalBudgetVsExpensesChart" width="400" height="200"></canvas>
                  </div>
                  <div class="mortgage-result">
                      <div class="result-item">
                          <span>Total Monthly Budget:</span>
                          <span id="dashboardTotalBudget">€0</span>
                      </div>
                      <div class="result-item">
                          <span>Total Monthly Expenses:</span>
                          <span id="dashboardTotalExpenses">€0</span>
                      </div>
                      <div class="result-item">
                          <span>Remaining Budget:</span>
                          <span id="remainingBudget">€0</span>
                      </div>
                      <div class="result-item">
                          <span>Budget Status:</span>
                          <span id="budgetStatus">-</span>
                      </div>
                  </div>
              </div>
              
              <div class="section">
                <h2>Financial Overview</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Income (Target vs Actual)</div>
                        <div class="summary-value" id="totalIncome">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;">
                            Target: <span id="targetIncome">€0</span>
                        </div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="incomeVariance">
                            Difference: €0
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Expenses (Budget vs Actual)</div>
                        <div class="summary-value" id="totalExpenses">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;">
                            Budget: <span id="targetExpenses">€0</span>
                        </div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="expensesVariance">
                            Difference: €0
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Net Cash Flow (Target vs Actual)</div>
                        <div class="summary-value" id="netCashFlow">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;">
                            Target: <span id="targetCashFlow">€0</span>
                        </div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="cashFlowVariance">
                            Difference: €0
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cashFlowChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="section">
                <h2>Budget Breakdown Analysis (50/30/20 Rule)</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Housing (50%)</div>
                        <div class="summary-value" id="housingTotal">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;" id="housingPercentage">0% of expenses</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="housingRulePercentage">0% of rule target</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Lifestyle (30%)</div>
                        <div class="summary-value" id="lifestyleTotal">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;" id="lifestylePercentage">0% of expenses</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="lifestyleRulePercentage">0% of rule target</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Savings (20%)</div>
                        <div class="summary-value" id="savingsTotal">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 3px; opacity: 0.8;" id="savingsPercentage">0% of expenses</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 2px; opacity: 0.7;" id="savingsRulePercentage">0% of rule target</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="budgetPieChart" width="400" height="200"></canvas>
                </div>
                <div class="mortgage-result">
                    <div class="result-item">
                        <span>50/30/20 Rule - Housing:</span>
                        <span id="fiftyThirtyTwentyHousing">€0 (0%)</span>
                    </div>
                    <div class="result-item">
                        <span>50/30/20 Rule - Lifestyle:</span>
                        <span id="fiftyThirtyTwentyLifestyle">€0 (0%)</span>
                    </div>
                    <div class="result-item">
                        <span>50/30/20 Rule - Savings:</span>
                        <span id="fiftyThirtyTwentySavings">€0 (0%)</span>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Budget vs Actual Spending</h2>
                <div class="summary-grid">
                   <div class="summary-card">
                       <div class="summary-label">Rent/Housing</div>
                       <div class="summary-value" id="rentHousingBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="rentHousingStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Utilities</div>
                       <div class="summary-value" id="utilitiesBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="utilitiesStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Groceries</div>
                       <div class="summary-value" id="groceriesBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="groceriesStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Eating Out</div>
                       <div class="summary-value" id="eatingOutBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="eatingOutStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                </div>
                <div class="summary-grid">
                   <div class="summary-card">
                       <div class="summary-label">Transportation</div>
                       <div class="summary-value" id="transportationBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="transportationStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Entertainment</div>
                       <div class="summary-value" id="entertainmentBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="entertainmentStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Shopping</div>
                       <div class="summary-value" id="shoppingBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="shoppingStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Hobbies</div>
                       <div class="summary-value" id="hobbiesBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="hobbiesStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                </div>
                <div class="summary-grid">
                   <div class="summary-card">
                       <div class="summary-label">Internet/Phone</div>
                       <div class="summary-value" id="internetPhoneBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="internetPhoneStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Insurance</div>
                       <div class="summary-value" id="insuranceBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="insuranceStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">ETF Investment</div>
                       <div class="summary-value" id="etfInvestmentBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="etfInvestmentStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                   <div class="summary-card">
                       <div class="summary-label">Miscellaneous</div>
                       <div class="summary-value" id="miscellaneousBudgetVsActual">€0 / €0</div>
                       <div class="summary-label" id="miscellaneousStatus" style="font-size: 12px; margin-top: 5px;">No Budget Set</div>
                   </div>
                </div>
                <div class="chart-container">
                    <canvas id="budgetVsActualChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="section">
                <h2>Budget Breakdown Analysis</h2>
                
                <!-- Housing Subsection (50%) -->
                <div style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Housing (50% Rule)</h3>
                    <div style="margin: 0 0 15px 0; padding: 15px; background: #e2e8f0; border-radius: 8px; font-size: 14px; color: #4a5568;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Rule Target (50%)</div>
                                <div><strong>Target:</strong> <span id="housingRuleTarget">€0</span></div>
                                <div><strong>Actual:</strong> <span id="housingActualAmount">€0</span></div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Performance</div>
                                <div><span id="housingPercentOfIncome">0%</span> of income</div>
                                <div><span id="housingPercentOfExpenses">0%</span> of expenses</div>
                                <div><span id="housingPercentOfTarget">0%</span> of rule target</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Rent/Housing</div>
                            <div class="summary-value" id="housingRent">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Utilities</div>
                            <div class="summary-value" id="housingUtilities">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Insurance</div>
                            <div class="summary-value" id="housingInsurance">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Internet/Phone</div>
                            <div class="summary-value" id="housingInternet">€0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Lifestyle Subsection (30%) -->
                <div style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Lifestyle (30% Rule)</h3>
                    <div style="margin: 0 0 15px 0; padding: 15px; background: #e2e8f0; border-radius: 8px; font-size: 14px; color: #4a5568;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Rule Target (30%)</div>
                                <div><strong>Target:</strong> <span id="lifestyleRuleTarget">€0</span></div>
                                <div><strong>Actual:</strong> <span id="lifestyleActualAmount">€0</span></div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Performance</div>
                                <div><span id="lifestylePercentOfIncome">0%</span> of income</div>
                                <div><span id="lifestylePercentOfExpenses">0%</span> of expenses</div>
                                <div><span id="lifestylePercentOfTarget">0%</span> of rule target</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Groceries</div>
                            <div class="summary-value" id="lifestyleGroceries">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Eating Out</div>
                            <div class="summary-value" id="lifestyleEatingOut">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Transportation</div>
                            <div class="summary-value" id="lifestyleTransportation">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Entertainment</div>
                            <div class="summary-value" id="lifestyleEntertainment">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Shopping</div>
                            <div class="summary-value" id="lifestyleShopping">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Hobbies</div>
                            <div class="summary-value" id="lifestyleHobbies">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Miscellaneous</div>
                            <div class="summary-value" id="lifestyleMisc">€0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Savings Subsection (20%) -->
                <div style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Savings (20% Rule)</h3>
                    <div style="margin: 0 0 15px 0; padding: 15px; background: #e2e8f0; border-radius: 8px; font-size: 14px; color: #4a5568;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Rule Target (20%)</div>
                                <div><strong>Target:</strong> <span id="savingsRuleTarget">€0</span></div>
                                <div><strong>Actual:</strong> <span id="savingsActualAmount">€0</span></div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px;">Performance</div>
                                <div><span id="savingsPercentOfIncome">0%</span> of income</div>
                                <div><span id="savingsPercentOfExpenses">0%</span> of expenses</div>
                                <div><span id="savingsPercentOfTarget">0%</span> of rule target</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label" id="savingsTransactionsLabel">Savings Transactions</div>
                            <div class="summary-value" id="savingsTransactions">€0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">ETF Investment</div>
                            <div class="summary-value" id="savingsETF">€0</div>
                        </div>
                    </div>
                </div>
                
                <div class="mortgage-result">
                    <div class="result-item">
                        <span>Biggest Expense Category:</span>
                        <span id="biggestExpense">-</span>
                    </div>
                    <div class="result-item">
                        <span>Savings Rate:</span>
                        <span id="savingsRate">0%</span>
                    </div>
                    <div class="result-item">
                        <span>Emergency Fund Coverage:</span>
                        <span id="emergencyFundCoverage">0 months</span>
                    </div>
                </div>
            </div>
            
            <div class="data-controls">
                <button class="export-btn" onclick="exportToCSV()">📊 Export to CSV</button>
                <button class="export-btn" onclick="downloadTemplate()">📝 Download CSV Template</button>
                <button class="export-btn" onclick="document.getElementById('csvFileInput').click()">📥 Import from CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                <button class="export-btn" onclick="saveData()">💾 Save Data Locally</button>
                <button class="export-btn" onclick="loadData()">📂 Load Saved Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            
            <!-- Welcome Section -->
            <div class="section">
                <h2>🧠 Advanced Financial Analytics</h2>
                <div id="analyticsWelcome" style="padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; color: white; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.4em;">💡 Intelligent Financial Insights</h3>
                    <p style="margin: 0; opacity: 0.9; line-height: 1.6;">
                        Discover patterns in your spending, predict future expenses, and get AI-powered recommendations for optimizing your financial health. 
                        Use the tools below to gain deep insights into your financial behavior and make data-driven decisions.
                    </p>
                </div>
                
                <!-- Insufficient Data Notice (Hidden by default) -->
                <div id="insufficientDataNotice" style="display: none; padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; color: white; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.4em;">📊 Building Your Analytics</h3>
                    <p style="margin: 0; opacity: 0.9; line-height: 1.6;">
                        Analytics features require at least 3 months of transaction data to provide meaningful insights. 
                        Keep adding transactions and the Analytics tab will automatically appear when enough data is available!
                    </p>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                        <strong>Current Progress:</strong> <span id="dataProgressText">0 months</span> of 3 months needed
                        <div style="width: 100%; background: rgba(255,255,255,0.3); border-radius: 4px; height: 8px; margin-top: 8px;">
                            <div id="dataProgressBar" style="width: 0%; background: rgba(255,255,255,0.8); border-radius: 4px; height: 100%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Historical Trends Section -->
            <div class="section">
                <h2>📈 Historical Trends & Patterns</h2>
                
                <!-- Trend Analysis Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">📊 Analysis Period</label>
                            <select id="trendsAnalysisPeriod" onchange="updateHistoricalTrends()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="3">Last 3 Months</option>
                                <option value="6" selected>Last 6 Months</option>
                                <option value="12">Last 12 Months</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">🏷️ Focus Category</label>
                            <select id="trendsCategoryFocus" onchange="updateHistoricalTrends()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="all">All Categories</option>
                                <option value="Rent/Housing">Rent/Housing</option>
                                <option value="Groceries">Groceries</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Eating Out">Eating Out</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Hobbies">Hobbies</option>
                                <option value="Utilities">Utilities</option>
                                <option value="ETF Investment">ETF Investment</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">📈 View Type</label>
                            <select id="trendsViewType" onchange="updateHistoricalTrends()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="spending">Monthly Spending</option>
                                <option value="income">Monthly Income</option>
                                <option value="cashflow">Net Cash Flow</option>
                                <option value="savings">Savings Rate</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Trends Chart -->
                <div class="chart-container">
                    <canvas id="historicalTrendsChart" width="400" height="200"></canvas>
                </div>
                
                <!-- Trend Insights -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Trend Direction</div>
                        <div class="summary-value" id="trendDirection">📈 Stable</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="trendPercentage">0% change</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Average Monthly</div>
                        <div class="summary-value" id="trendAverage">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="trendPeriodInfo">Last 6 months</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Peak Month</div>
                        <div class="summary-value" id="trendPeak">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="trendPeakMonth">No data</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Lowest Month</div>
                        <div class="summary-value" id="trendLowest">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="trendLowestMonth">No data</div>
                    </div>
                </div>
                
                <!-- Pattern Analysis -->
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                    <h3 style="margin: 0 0 15px 0; color: #0369a1;">🔍 Pattern Analysis</h3>
                    <div id="patternAnalysis" style="color: #0c4a6e; line-height: 1.6;">
                        <p>📊 Select an analysis period to view spending patterns and trends.</p>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Analytics Section -->
            <div class="section">
                <h2>🎯 Predictive Analytics & Forecasting</h2>
                
                <!-- Analytics Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: #fef7ff; border-radius: 8px; border: 1px solid #e879f9;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">🎯 Analysis Type</label>
                            <select id="analyticsType" onchange="updateAdvancedAnalytics()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="forecasting" selected>Spending Forecasting</option>
                                <option value="variance">Budget Variance Analysis</option>
                                <option value="seasonal">Seasonal Patterns</option>
                                <option value="efficiency">Financial Efficiency</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">📅 Forecast Period</label>
                            <select id="forecastPeriod" onchange="updateAdvancedAnalytics()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="1">Next 1 Month</option>
                                <option value="3" selected>Next 3 Months</option>
                                <option value="6">Next 6 Months</option>
                                <option value="12">Next 12 Months</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Chart -->
                <div class="chart-container">
                    <canvas id="advancedAnalyticsChart" width="400" height="200"></canvas>
                </div>
                
                <!-- Key Insights Grid -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Predicted Next Month</div>
                        <div class="summary-value" id="predictedSpending">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="predictionConfidence">Based on trends</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Budget Efficiency</div>
                        <div class="summary-value" id="budgetEfficiency">0%</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="efficiencyTrend">vs last month</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Savings Potential</div>
                        <div class="summary-value" id="savingsPotential">€0</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="savingsOpportunity">Identified areas</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Risk Assessment</div>
                        <div class="summary-value" id="riskAssessment">🟢 Low</div>
                        <div class="summary-label" style="font-size: 12px; margin-top: 5px;" id="riskFactors">Financial health</div>
                    </div>
                </div>
                
                <!-- Advanced Insights -->
                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Spending Recommendations -->
                        <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                            <h3 style="margin: 0 0 15px 0; color: #166534;">💡 Smart Recommendations</h3>
                            <div id="spendingRecommendations" style="color: #14532d; line-height: 1.6;">
                                <p>🎯 Analyzing your spending patterns to provide personalized recommendations...</p>
                            </div>
                        </div>
                        
                        <!-- Financial Health Score -->
                        <div style="padding: 15px; background: #fffbeb; border-radius: 8px; border: 1px solid #fed7aa;">
                            <h3 style="margin: 0 0 15px 0; color: #d97706;">📊 Financial Health Score</h3>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="display: inline-block; position: relative; width: 120px; height: 120px;">
                                    <canvas id="healthScoreChart" width="120" height="120"></canvas>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: #d97706;" id="healthScoreValue">--</div>
                                </div>
                            </div>
                            <div id="healthScoreBreakdown" style="color: #92400e; line-height: 1.6; font-size: 14px;">
                                <p>📈 Complete your financial data to see your health score.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Export -->
            <div class="section">
                <h2>📊 Analytics Export & Reports</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <button class="export-btn" onclick="exportAdvancedAnalyticsReport()">📈 Export Trends Report</button>
                    <button class="export-btn" onclick="exportForecastingReport()">🔮 Export Forecast Report</button>
                    <button class="export-btn" onclick="exportHealthScoreReport()">💚 Export Health Report</button>
                    <button class="export-btn" onclick="exportFullAnalyticsReport()">📋 Export Complete Analysis</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;">📄 Report Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px; color: #6b7280;">
                        <div>
                            <p><strong>Trends Report:</strong> Historical analysis with pattern insights</p>
                            <p><strong>Forecast Report:</strong> Predictive analytics and future projections</p>
                        </div>
                        <div>
                            <p><strong>Health Report:</strong> Financial health score breakdown and recommendations</p>
                            <p><strong>Complete Analysis:</strong> All analytics data in one comprehensive report</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="version-info">
            Financial Tracker v2.3 - Local HTML App | Last modified: <span id="lastModified"></span>
            <br><br>
            <strong>Created by:</strong> Abhishek Siddaraju & Claude (Anthropic AI)
            <br>
            <em>Enhanced with historical trends, advanced analytics, transaction filtering, and AI-powered financial insights</em>
        </div>
    </div>
    
    <script>
        /*
         * Personal Financial Tracker v2.3
         * Created by: Abhishek Siddaraju & Claude (Anthropic AI)
         * 
         * Version History:
         * v1.0 - Initial release with basic transaction tracking and budget management
         * v2.0 - Enhanced with:
         *   - Target vs Actual analysis in Financial Overview
         *   - ETF Portfolio tracking with growth calculations
         *   - Remaining Budget display
         *   - 50/30/20 Rule analysis with detailed breakdowns
         *   - Bank account balance tracking
         *   - Advanced charts with comparison views
         *   - Comprehensive dashboard with multiple analysis sections
         * v2.1 - Phase 4 Implementation (Steps 1-2):
         *   - Month Navigation: Select and view any historical month
         *   - Month Comparison: Side-by-side comparison between months
         *   - Dashboard Controls: Prev/Next navigation and comparison toggle
         *   - Monthly Reports: Export detailed monthly financial reports
         *   - Transaction Filtering: Month and category filters for transaction management
         * v2.2 - Phase 4 Implementation (Steps 3-4):
         *   - Historical Trends: Advanced spending pattern analysis with volatility tracking
         *   - Advanced Analytics: AI-powered forecasting with linear regression
         *   - Financial Health Score: Multi-factor health assessment with visual indicators
         *   - Smart Recommendations: Personalized insights and optimization suggestions
         *   - Pattern Analysis: Seasonal trends and spending behavior identification
         * v2.3 - Enhanced Transaction Management:
         *   - Transaction Table Sorting: Click any column header to sort ascending/descending
         *   - Smart Sort Indicators: Visual arrows showing current sort state
         *   - Multi-Column Sorting: Sort by date, description, category, amount, or payment method
         *   - Interactive Headers: Professional sorting interface with hover effects
         */
        
        // Initialize with today's date
        document.getElementById('transDate').valueAsDate = new Date();
        document.getElementById('etfDate').valueAsDate = new Date();
        document.getElementById('lastModified').textContent = new Date().toLocaleDateString('en-GB');
        
        let transactions = [];
        let etfTransactions = [];
        let charts = {}; // Store chart instances
        let monthlyETFContribution = 0; // Track monthly ETF contribution
        let chartsInitializing = false; // Prevent multiple initialization
        
        // Phase 4: Month Navigation & Comparison
        let currentViewDate = new Date(); // Currently selected month for viewing
        let comparisonMode = false; // Whether comparison mode is enabled
        let compareDate = new Date(); // Month to compare against
        let monthlyData = {}; // Cache for monthly data
        
        // Transaction Filtering
        let transactionViewDate = null; // Selected month for transaction view (null = all time)
        let transactionCategoryFilter = 'all'; // Selected category filter
        
        // Transaction Sorting
        let currentSortColumn = 'date'; // Current column being sorted
        let currentSortDirection = 'desc'; // Current sort direction (asc/desc)
        
        // Load data on startup
        window.onload = function() {
            // Load existing data if available
            
            loadData(true); // Silent load on startup
            updateSummary();
            updateBankBalance();
            updateTotalMonthlyBudget(); // Initialize total monthly budget
            displayETFTransactions(); // Initialize ETF transactions display
            initializeCharts();
            initializeMonthSelectors(); // Initialize month navigation
            initializeTransactionFilters(); // Initialize transaction filtering
            checkAnalyticsAvailability(); // Check if analytics should be available
            
            // Ensure charts are updated with real data after everything is loaded
            setTimeout(() => {
                updateCharts();
                updateHistoricalTrends();
                updateAdvancedAnalytics();
            }, 1000);
            
            // Try multiple times to ensure charts are loaded
            setTimeout(() => {
                updateCharts();
                updateHistoricalTrends();
                updateAdvancedAnalytics();
            }, 2000);
        };
        
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Initialize charts when switching to dashboard tab
            if (tabName === 'dashboard') {
                setTimeout(() => {
                    const dashboardChartsExist = charts.budgetPie && charts.cashFlow && charts.budgetVsActual && charts.totalBudgetVsExpenses;
                    const allChartsExist = dashboardChartsExist && charts.historicalTrends && charts.advancedAnalytics && charts.healthScore;
                    
                    if (!allChartsExist && !chartsInitializing) {
                        console.log('Some charts missing, initializing...');
                        initializeCharts();
                    } else if (dashboardChartsExist) {
                        console.log('Dashboard charts exist, resizing and updating...');
                        if (charts.budgetPie) charts.budgetPie.resize();
                        if (charts.cashFlow) charts.cashFlow.resize();
                        if (charts.budgetVsActual) charts.budgetVsActual.resize();
                        if (charts.totalBudgetVsExpenses) charts.totalBudgetVsExpenses.resize();
                        
                        // Update charts with current data when switching to dashboard
                        updateCharts();
                        console.log('Dashboard charts updated');
                    } else {
                        console.log('Charts still initializing, will update when ready');
                    }
                }, 200);
            }
            
            // Initialize analytics charts when switching to analytics tab
            if (tabName === 'analytics') {
                setTimeout(() => {
                    const analyticsChartsExist = charts.historicalTrends && charts.advancedAnalytics && charts.healthScore;
                    const allChartsExist = charts.budgetPie && charts.cashFlow && charts.budgetVsActual && charts.totalBudgetVsExpenses && analyticsChartsExist;
                    
                    if (!allChartsExist && !chartsInitializing) {
                        console.log('Some charts missing, initializing...');
                        initializeCharts();
                    } else if (analyticsChartsExist) {
                        console.log('Analytics charts exist, resizing and updating...');
                        if (charts.historicalTrends) charts.historicalTrends.resize();
                        if (charts.advancedAnalytics) charts.advancedAnalytics.resize();
                        if (charts.healthScore) charts.healthScore.resize();
                        
                        // Update analytics charts when switching to analytics tab
                        updateHistoricalTrends();
                        updateAdvancedAnalytics();
                        console.log('Analytics charts updated');
                    } else {
                        console.log('Charts still initializing, will update when ready');
                    }
                }, 200);
            }
            
            // Update ETF transactions when switching to ETF tab
            if (tabName === 'etf-transactions') {
                displayETFTransactions();
            }
            
            // Initialize month selectors when switching to dashboard
            if (tabName === 'dashboard') {
                initializeMonthSelectors();
            }
            
            // Initialize transaction filters when switching to transactions tab
            if (tabName === 'transactions') {
                initializeTransactionFilters();
            }
        }
        
        function initializeCharts() {
            // Prevent multiple simultaneous initialization
            if (chartsInitializing) {
                console.log('Charts already initializing, skipping...');
                return;
            }
            
            chartsInitializing = true;
            
            // Wait a bit for DOM to be ready
            setTimeout(() => {
                try {
                    console.log('Initializing charts...');
                    
                    // Destroy existing charts to avoid "Canvas is already in use" error
                    if (charts.budgetPie) charts.budgetPie.destroy();
                    if (charts.cashFlow) charts.cashFlow.destroy();
                    if (charts.budgetVsActual) charts.budgetVsActual.destroy();
                    if (charts.totalBudgetVsExpenses) charts.totalBudgetVsExpenses.destroy();
                    if (charts.historicalTrends) charts.historicalTrends.destroy();
                    if (charts.advancedAnalytics) charts.advancedAnalytics.destroy();
                    if (charts.healthScore) charts.healthScore.destroy();
                    
                    // Reset charts object
                    charts = {};
                    // Budget Breakdown Pie Chart
                    const budgetCtx = document.getElementById('budgetPieChart');
                    if (budgetCtx) {
                        charts.budgetPie = new Chart(budgetCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Housing (50%)', 'Lifestyle (30%)', 'Savings (20%)'],
                                datasets: [{
                                    data: [0, 0, 0], // Start with zero values
                                    backgroundColor: [
                                        '#667eea',  // Blue for Housing
                                        '#764ba2',  // Purple for Lifestyle
                                        '#48bb78'   // Green for Savings
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#ffffff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                
                                                // Calculate percentage of income (not expenses) for 50/30/20 comparison
                                                const salary = parseFloat(document.getElementById('salary').value) || 0;
                                                const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
                                                const totalIncome = salary + otherIncome;
                                                
                                                let percentageOfIncome = 0;
                                                if (totalIncome > 0) {
                                                    percentageOfIncome = ((value / totalIncome) * 100).toFixed(1);
                                                }
                                                
                                                return `${label}: €${value.toLocaleString()} (${percentageOfIncome}% of income)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    

                    
                    // Cash Flow Chart
                    const cashFlowCtx = document.getElementById('cashFlowChart');
                    if (cashFlowCtx) {
                        charts.cashFlow = new Chart(cashFlowCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Income', 'Expenses', 'Net Cash Flow'],
                                datasets: [{
                                    label: 'Target (€)',
                                    data: [0, 0, 0], // Start with zero values
                                    backgroundColor: '#667eea',
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }, {
                                    label: 'Actual (€)',
                                    data: [0, 0, 0], // Start with zero values
                                    backgroundColor: '#48bb78',
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.dataset.label}: €${context.parsed.y.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Budget vs Actual Chart
                    const budgetVsActualCtx = document.getElementById('budgetVsActualChart');
                    if (budgetVsActualCtx) {
                        charts.budgetVsActual = new Chart(budgetVsActualCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Rent/Housing', 'Utilities', 'Groceries', 'Eating Out', 'Transportation', 'Entertainment', 'Shopping', 'Hobbies', 'Internet/Phone', 'Insurance', 'Miscellaneous', 'ETF Investment'],
                                datasets: [{
                                    label: 'Budget (€)',
                                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // Start with zero values
                                    backgroundColor: '#667eea',
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }, {
                                    label: 'Actual (€)',
                                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // Start with zero values
                                    backgroundColor: '#48bb78',
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.dataset.label}: €${context.parsed.y.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    
                    // Total Budget vs Total Expenses Chart
                    const totalBudgetVsExpensesCtx = document.getElementById('totalBudgetVsExpensesChart');
                    if (totalBudgetVsExpensesCtx) {
                        charts.totalBudgetVsExpenses = new Chart(totalBudgetVsExpensesCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Total Budget', 'Total Expenses'],
                                datasets: [{
                                    label: 'Amount (€)',
                                    data: [0, 0], // Start with zero values
                                    backgroundColor: [
                                        '#667eea', // Blue for budget
                                        '#48bb78'  // Green for expenses
                                    ],
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `€${context.parsed.y.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Historical Trends Chart
                    const trendsCtx = document.getElementById('historicalTrendsChart');
                    if (trendsCtx) {
                        charts.historicalTrends = new Chart(trendsCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Monthly Spending',
                                    data: [],
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.dataset.label}: €${context.parsed.y.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Advanced Analytics Chart
                    const analyticsCtx = document.getElementById('advancedAnalyticsChart');
                    if (analyticsCtx) {
                        charts.advancedAnalytics = new Chart(analyticsCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Historical',
                                    data: [],
                                    borderColor: '#48bb78',
                                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                                    borderWidth: 2,
                                    fill: false
                                }, {
                                    label: 'Predicted',
                                    data: [],
                                    borderColor: '#f56565',
                                    backgroundColor: 'rgba(245, 101, 101, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.dataset.label}: €${context.parsed.y.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Financial Health Score Chart (Doughnut)
                    const healthCtx = document.getElementById('healthScoreChart');
                    if (healthCtx) {
                        charts.healthScore = new Chart(healthCtx, {
                            type: 'doughnut',
                            data: {
                                datasets: [{
                                    data: [75, 25], // Score and remainder
                                    backgroundColor: ['#10b981', '#e5e7eb'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: false,
                                maintainAspectRatio: false,
                                cutout: '75%',
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        enabled: false
                                    }
                                }
                            }
                        });
                    }
                    
                    console.log('Charts initialized successfully:', Object.keys(charts));
                    console.log('Chart objects:', charts);
                    
                    // Reset the initializing flag
                    chartsInitializing = false;
                    
                    // Try to update charts immediately after initialization
                    setTimeout(() => {
                        updateCharts();
                    }, 100);
                } catch (error) {
                    console.error('Error initializing charts:', error);
                    chartsInitializing = false; // Reset flag on error too
                }
            }, 500);
        }
        

        
        function addTransaction() {
            const date = document.getElementById('transDate').value;
            const desc = document.getElementById('transDesc').value;
            const category = document.getElementById('transCategory').value;
            const amount = parseFloat(document.getElementById('transAmount').value) || 0;
            const paymentMethod = document.getElementById('transPaymentMethod').value;
            
            if (!date || !desc || amount === 0) {
                alert('Please fill all fields');
                return;
            }
            
            const transaction = { date, desc, category, amount, paymentMethod };
            transactions.push(transaction);
            displayTransactions();
            saveData(true); // Auto-save after adding transaction
            checkAnalyticsAvailability(); // Check if analytics should be available
            
            // Clear inputs
            document.getElementById('transDesc').value = '';
            document.getElementById('transAmount').value = '';
        }
        
        function displayTransactions() {
            const tbody = document.getElementById('transactionList');
            tbody.innerHTML = '';
            
            let totalIncome = 0;
            let totalExpenses = 0;
            
            // Apply filters
            const filteredTransactions = getFilteredTransactions();
            
            // Apply sorting to filtered transactions
            const sortedTransactions = getSortedTransactions(filteredTransactions);

            sortedTransactions.forEach((trans, filteredIndex) => {
                // Find the actual index in the full transactions array
                const actualIndex = transactions.findIndex(t => t === trans);
                
                // Format date to dd/mm/yyyy
                const dateObj = new Date(trans.date);
                const formattedDate = dateObj.toLocaleDateString('en-GB');
                
                const amount = parseFloat(trans.amount);
                if (trans.category === 'Income') {
                    totalIncome += amount;
                } else {
                    totalExpenses += amount;
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>
                        <span class="transaction-desc" id="desc-${actualIndex}">${trans.desc}</span>
                        <input type="text" class="transaction-edit" id="edit-desc-${actualIndex}" value="${trans.desc}" style="display: none; width: 100%; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </td>
                    <td>
                        <span class="transaction-category" id="category-${actualIndex}">${trans.category}</span>
                        <select class="transaction-edit" id="edit-category-${actualIndex}" style="display: none; width: 100%; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            <option value="Income" ${trans.category === 'Income' ? 'selected' : ''}>Income</option>
                            <option value="Rent/Housing" ${trans.category === 'Rent/Housing' ? 'selected' : ''}>Rent/Housing</option>
                            <option value="Utilities" ${trans.category === 'Utilities' ? 'selected' : ''}>Utilities</option>
                            <option value="Groceries" ${trans.category === 'Groceries' ? 'selected' : ''}>Groceries</option>
                            <option value="Transportation" ${trans.category === 'Transportation' ? 'selected' : ''}>Transportation</option>
                            <option value="Entertainment" ${trans.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                            <option value="Shopping" ${trans.category === 'Shopping' ? 'selected' : ''}>Shopping</option>
                            <option value="Savings" ${trans.category === 'Savings' ? 'selected' : ''}>Savings</option>
                            <option value="ETF Investment" ${trans.category === 'ETF Investment' ? 'selected' : ''}>ETF Investment</option>
                            <option value="Eating Out" ${trans.category === 'Eating Out' ? 'selected' : ''}>Eating Out</option>
                            <option value="Internet/Phone" ${trans.category === 'Internet/Phone' ? 'selected' : ''}>Internet/Phone</option>
                            <option value="Hobbies" ${trans.category === 'Hobbies' ? 'selected' : ''}>Hobbies</option>
                            <option value="Miscellaneous" ${trans.category === 'Miscellaneous' ? 'selected' : ''}>Miscellaneous</option>
                            <option value="Other" ${trans.category === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </td>
                    <td>
                        <span class="transaction-amount ${trans.category === 'Income' ? 'positive' : 'negative'}" id="amount-${actualIndex}">
                            €${amount.toFixed(2)}
                        </span>
                        <input type="number" class="transaction-edit" id="edit-amount-${actualIndex}" value="${amount}" step="0.01" style="display: none; width: 100%; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </td>
                    <td>
                        <span class="transaction-payment" id="payment-${actualIndex}">${trans.paymentMethod}</span>
                        <select class="transaction-edit" id="edit-payment-${actualIndex}" style="display: none; width: 100%; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            <option value="Card" ${trans.paymentMethod === 'Card' ? 'selected' : ''}>Card</option>
                            <option value="PayPal" ${trans.paymentMethod === 'PayPal' ? 'selected' : ''}>PayPal</option>
                            <option value="Bank Transfer" ${trans.paymentMethod === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                            <option value="Cash" ${trans.paymentMethod === 'Cash' ? 'selected' : ''}>Cash</option>
                            <option value="Other" ${trans.paymentMethod === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-primary" id="edit-btn-${actualIndex}" onclick="editTransaction(${actualIndex})" style="margin-right: 5px; padding: 5px 10px; font-size: 12px;">Edit</button>
                        <button class="btn btn-success" id="save-btn-${actualIndex}" onclick="saveTransaction(${actualIndex})" style="display: none; margin-right: 5px; padding: 5px 10px; font-size: 12px;">Save</button>
                        <button class="btn btn-danger" onclick="removeTransaction(${actualIndex})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                    </td>
                `;
            });

            // Update totals display
            document.getElementById('transactionCount').textContent = filteredTransactions.length;
            document.getElementById('transactionTotalIncome').textContent = '€' + totalIncome.toFixed(2);
            document.getElementById('transactionTotalExpenses').textContent = '€' + totalExpenses.toFixed(2);
            document.getElementById('transactionNetAmount').textContent = '€' + (totalIncome - totalExpenses).toFixed(2);
            
            // Update filter status
            updateTransactionFilterStatus(filteredTransactions.length, transactions.length);
            
            // Update bank balance
            updateBankBalance();
        }
        
        function editTransaction(index) {
            // Hide display elements and show edit elements
            document.getElementById(`desc-${index}`).style.display = 'none';
            document.getElementById(`edit-desc-${index}`).style.display = 'inline-block';
            document.getElementById(`category-${index}`).style.display = 'none';
            document.getElementById(`edit-category-${index}`).style.display = 'inline-block';
            document.getElementById(`amount-${index}`).style.display = 'none';
            document.getElementById(`edit-amount-${index}`).style.display = 'inline-block';
            document.getElementById(`payment-${index}`).style.display = 'none';
            document.getElementById(`edit-payment-${index}`).style.display = 'inline-block';
            
            // Hide edit button and show save button
            document.getElementById(`edit-btn-${index}`).style.display = 'none';
            document.getElementById(`save-btn-${index}`).style.display = 'inline-block';
        }
        
        function saveTransaction(index) {
            // Get edited values
            const newDesc = document.getElementById(`edit-desc-${index}`).value;
            const newCategory = document.getElementById(`edit-category-${index}`).value;
            const newAmount = parseFloat(document.getElementById(`edit-amount-${index}`).value) || 0;
            const newPaymentMethod = document.getElementById(`edit-payment-${index}`).value;
            
            // Update transaction
            transactions[index].desc = newDesc;
            transactions[index].category = newCategory;
            transactions[index].amount = newAmount;
            transactions[index].paymentMethod = newPaymentMethod;
            
            // Refresh display
            displayTransactions();
            saveData(true);
        }
        
        function removeTransaction(index) {
            const amount = parseFloat(transactions[index].amount);
            if (transactions[index].category === 'Income') {
                totalIncome -= amount;
                document.getElementById('transactionTotalIncome').textContent = '€' + totalIncome.toFixed(2);
                document.getElementById('transactionNetAmount').textContent = '€' + (totalIncome - totalExpenses).toFixed(2);
            } else {
                totalExpenses -= amount;
                document.getElementById('transactionTotalExpenses').textContent = '€' + totalExpenses.toFixed(2);
                document.getElementById('transactionNetAmount').textContent = '€' + (totalIncome - totalExpenses).toFixed(2);
            }
            transactions.splice(index, 1);
            displayTransactions();
            saveData(true); // Auto-save after removing transaction
            checkAnalyticsAvailability(); // Check if analytics should be available
        }
        
        function updateBankBalance() {
            const startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;
            const balanceAsOfDate = document.getElementById('balanceAsOfDate').value;
            
            if (!balanceAsOfDate) {
                // If no date is set, show starting balance only
                document.getElementById('currentBalance').value = startingBalance.toFixed(2);
                document.getElementById('balanceStatus').textContent = 'Set Balance Date';
                document.getElementById('balanceStatus').style.backgroundColor = '#f7fafc';
                document.getElementById('balanceStatus').style.borderColor = '#e2e8f0';
                document.getElementById('balanceStatus').style.color = '#718096';
                document.getElementById('balanceChange').textContent = '€0.00';
                return;
            }
            
            // Calculate current balance from transactions AFTER the balance as of date
            let currentBalance = startingBalance;
            let balanceChange = 0;
            
            transactions.forEach(trans => {
                const transDate = new Date(trans.date);
                const balanceDate = new Date(balanceAsOfDate);
                
                // Only include transactions after the balance as of date
                if (transDate > balanceDate) {
                    if (trans.category === 'Income') {
                        currentBalance += parseFloat(trans.amount);
                        balanceChange += parseFloat(trans.amount);
                    } else {
                        currentBalance -= parseFloat(trans.amount);
                        balanceChange -= parseFloat(trans.amount);
                    }
                }
            });
            
            // Update current balance display
            document.getElementById('currentBalance').value = currentBalance.toFixed(2);
            
            // Update balance change display
            const balanceChangeElement = document.getElementById('balanceChange');
            if (balanceChange > 0) {
                balanceChangeElement.textContent = `+€${balanceChange.toFixed(2)}`;
                balanceChangeElement.style.backgroundColor = '#f0fff4';
                balanceChangeElement.style.borderColor = '#48bb78';
                balanceChangeElement.style.color = '#38a169';
            } else if (balanceChange < 0) {
                balanceChangeElement.textContent = `€${balanceChange.toFixed(2)}`;
                balanceChangeElement.style.backgroundColor = '#fff5f5';
                balanceChangeElement.style.borderColor = '#f56565';
                balanceChangeElement.style.color = '#e53e3e';
            } else {
                balanceChangeElement.textContent = '€0.00';
                balanceChangeElement.style.backgroundColor = '#f7fafc';
                balanceChangeElement.style.borderColor = '#e2e8f0';
                balanceChangeElement.style.color = '#718096';
            }
            
            // Update balance status
            const balanceStatus = document.getElementById('balanceStatus');
            if (balanceChange === 0) {
                balanceStatus.textContent = 'No New Transactions';
                balanceStatus.style.backgroundColor = '#f7fafc';
                balanceStatus.style.borderColor = '#e2e8f0';
                balanceStatus.style.color = '#718096';
            } else if (currentBalance >= startingBalance) {
                balanceStatus.textContent = 'Positive Change';
                balanceStatus.style.backgroundColor = '#f0fff4';
                balanceStatus.style.borderColor = '#48bb78';
                balanceStatus.style.color = '#38a169';
            } else {
                balanceStatus.textContent = 'Negative Change';
                balanceStatus.style.backgroundColor = '#fff5f5';
                balanceStatus.style.borderColor = '#f56565';
                balanceStatus.style.color = '#e53e3e';
            }
        }
        
        function updateTotalMonthlyBudget() {
            const budgetRent = parseFloat(document.getElementById('budgetRent').value) || 0;
            const budgetUtilities = parseFloat(document.getElementById('budgetUtilities').value) || 0;
            const budgetGroceries = parseFloat(document.getElementById('budgetGroceries').value) || 0;
            const budgetEatingOut = parseFloat(document.getElementById('budgetEatingOut').value) || 0;
            const budgetTransportation = parseFloat(document.getElementById('budgetTransportation').value) || 0;
            const budgetEntertainment = parseFloat(document.getElementById('budgetEntertainment').value) || 0;
            const budgetShopping = parseFloat(document.getElementById('budgetShopping').value) || 0;
            const budgetHobbies = parseFloat(document.getElementById('budgetHobbies').value) || 0;
            const budgetInternet = parseFloat(document.getElementById('budgetInternet').value) || 0;
            const budgetInsurance = parseFloat(document.getElementById('budgetInsurance').value) || 0;
            const budgetETFInvestment = parseFloat(document.getElementById('budgetETFInvestment').value) || 0;
            const budgetMisc = parseFloat(document.getElementById('budgetMisc').value) || 0;
            
            const totalMonthlyBudget = budgetRent + budgetUtilities + budgetGroceries + budgetEatingOut + 
                                     budgetTransportation + budgetEntertainment + budgetShopping + budgetHobbies + 
                                     budgetInternet + budgetInsurance + budgetETFInvestment + budgetMisc;
            
            document.getElementById('totalMonthlyBudget').textContent = '€' + totalMonthlyBudget.toLocaleString();
        }
        
        function updateSummary() {
            // Income
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            const totalIncome = salary + otherIncome;
            
            // Calculate actual expenses from transactions (not budget amounts)
            let totalExpenses = 0;
            const viewDate = currentViewDate || new Date(); // Use selected month or current month
            const viewMonth = viewDate.getMonth();
            const viewYear = viewDate.getFullYear();
            
            // Filter transactions for selected month
            const monthlyTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === viewMonth && 
                       transDate.getFullYear() === viewYear && 
                       trans.category !== 'Income';
            });
            
            // Calculate actual spending by category
            const actualSpending = {
                'Rent/Housing': 0,
                'Utilities': 0,
                'Groceries': 0,
                'Eating Out': 0,
                'Transportation': 0,
                'Entertainment': 0,
                'Shopping': 0,
                'Hobbies': 0,
                'Internet/Phone': 0,
                'Insurance': 0,
                'ETF Investment': 0,
                'Miscellaneous': 0
            };
            
            // Add missing Savings category to the object
            actualSpending['Savings'] = 0;
            
            monthlyTransactions.forEach(trans => {
                if (actualSpending.hasOwnProperty(trans.category)) {
                    actualSpending[trans.category] += parseFloat(trans.amount);
                }
                totalExpenses += parseFloat(trans.amount);
            });
            
            // Monthly Budget Categories (for budget vs actual comparison)
            const budgetRent = parseFloat(document.getElementById('budgetRent').value) || 0;
            const budgetUtilities = parseFloat(document.getElementById('budgetUtilities').value) || 0;
            const budgetGroceries = parseFloat(document.getElementById('budgetGroceries').value) || 0;
            const budgetEatingOut = parseFloat(document.getElementById('budgetEatingOut').value) || 0;
            const budgetTransportation = parseFloat(document.getElementById('budgetTransportation').value) || 0;
            const budgetEntertainment = parseFloat(document.getElementById('budgetEntertainment').value) || 0;
            const budgetShopping = parseFloat(document.getElementById('budgetShopping').value) || 0;
            const budgetHobbies = parseFloat(document.getElementById('budgetHobbies').value) || 0;
            const budgetInternet = parseFloat(document.getElementById('budgetInternet').value) || 0;
            const budgetInsurance = parseFloat(document.getElementById('budgetInsurance').value) || 0;
            const budgetMisc = parseFloat(document.getElementById('budgetMisc').value) || 0;
            const budgetETFInvestment = parseFloat(document.getElementById('budgetETFInvestment').value) || 0;

            const totalBudget = budgetRent + budgetUtilities + budgetGroceries + budgetEatingOut + budgetTransportation + budgetEntertainment + budgetShopping + budgetHobbies + budgetInternet + budgetInsurance + budgetMisc;
            
            // ETF Investments - get from ETF transactions
            let etfCurrentValue = 0;
            let etfPreviousValue = 0;
            
            if (etfTransactions.length > 0) {
                etfCurrentValue = etfTransactions[0].value; // Latest value
                if (etfTransactions.length > 1) {
                    etfPreviousValue = etfTransactions[1].value; // Previous value
                    monthlyETFContribution = etfCurrentValue - etfPreviousValue;
                }
            }
            
            // Calculate ETF metrics
            const projectedAnnualGrowth = etfCurrentValue * 0.005; // Default 0.5% growth
            const totalInvestmentValue = etfCurrentValue + (monthlyETFContribution * 12);
            const targetAllocationAmount = totalIncome * 0.005; // Default 0.5% allocation
            const allocationDifference = monthlyETFContribution - targetAllocationAmount;
            
            // Projected 5-year value with compound interest
            let projected5YearValue = etfCurrentValue;
            for (let year = 1; year <= 5; year++) {
                projected5YearValue = (projected5YearValue + (monthlyETFContribution * 12)) * 1.005; // Default 0.5% growth
            }
            
            // Net cash flow (including ETF contributions)
            const netCashFlow = totalIncome - totalExpenses - budgetETFInvestment - monthlyETFContribution;
            
                                     // Calculate 50/30/20 rule percentages based on actual spending
            const housingTotal = actualSpending['Rent/Housing'] + actualSpending['Utilities'] + actualSpending['Insurance'] + actualSpending['Internet/Phone'];
            const lifestyleTotal = actualSpending['Groceries'] + actualSpending['Eating Out'] + actualSpending['Transportation'] + actualSpending['Entertainment'] + actualSpending['Shopping'] + actualSpending['Hobbies'] + actualSpending['Miscellaneous'];
            
            // Use current bank balance as savings (liquid cash available)
            const currentBalanceForSavings = parseFloat(document.getElementById('currentBalance').value) || 0;
            const savingsTotal = currentBalanceForSavings;
            
            const housingPercentage = totalExpenses > 0 ? (housingTotal / totalExpenses * 100) : 0;
            const lifestylePercentage = totalExpenses > 0 ? (lifestyleTotal / totalExpenses * 100) : 0;
            const savingsPercentage = totalExpenses > 0 ? (savingsTotal / totalExpenses * 100) : 0;
            
            // 50/30/20 Rule calculations
            const fiftyThirtyTwentyHousing = totalIncome * 0.5;
            const fiftyThirtyTwentyLifestyle = totalIncome * 0.3;
            const fiftyThirtyTwentySavings = totalIncome * 0.2;
            
                         // Spending analysis
             const expenseCategories = [
                 { name: 'Housing', amount: actualSpending['Rent/Housing'] + actualSpending['Utilities'] },
                 { name: 'Transportation', amount: actualSpending['Transportation'] },
                 { name: 'Food & Dining', amount: actualSpending['Groceries'] + actualSpending['Eating Out'] },
                 { name: 'Entertainment', amount: actualSpending['Entertainment'] },
                 { name: 'Shopping', amount: actualSpending['Shopping'] },
                 { name: 'Lifestyle', amount: actualSpending['Internet/Phone'] + actualSpending['Insurance'] + actualSpending['Miscellaneous'] }
             ];
            
            const biggestExpense = expenseCategories.reduce((max, category) => 
                category.amount > max.amount ? category : max, { name: 'None', amount: 0 });
            
            const savingsRate = totalIncome > 0 ? (savingsTotal / totalIncome * 100) : 0;
            const emergencyFundCoverage = totalExpenses > 0 ? (currentBalanceForSavings / totalExpenses) : 0;
            
            // Update display
            document.getElementById('totalIncome').textContent = '€' + totalIncome.toLocaleString();
            document.getElementById('totalExpenses').textContent = '€' + totalExpenses.toLocaleString();
            document.getElementById('netCashFlow').textContent = '€' + netCashFlow.toLocaleString();
            
            // Calculate target values for Financial Overview
            const targetIncome = totalIncome; // Target income is the planned income (salary + other income)
            const targetExpenses = totalBudget; // Target expenses is the total budget
            const targetCashFlow = targetIncome - targetExpenses; // Target cash flow
            
            // Calculate variances (actual - target)
            const incomeVariance = totalIncome - targetIncome;
            const expensesVariance = totalExpenses - targetExpenses;
            const cashFlowVariance = netCashFlow - targetCashFlow;
            
            // Update target values display
            document.getElementById('targetIncome').textContent = '€' + targetIncome.toLocaleString();
            document.getElementById('targetExpenses').textContent = '€' + targetExpenses.toLocaleString();
            document.getElementById('targetCashFlow').textContent = '€' + targetCashFlow.toLocaleString();
            
            // Update variance displays with styling
            const incomeVarianceElement = document.getElementById('incomeVariance');
            incomeVarianceElement.textContent = 'Difference: ' + (incomeVariance >= 0 ? '+' : '') + '€' + incomeVariance.toLocaleString();
            incomeVarianceElement.style.color = incomeVariance >= 0 ? '#48bb78' : '#f56565';
            
            const expensesVarianceElement = document.getElementById('expensesVariance');
            expensesVarianceElement.textContent = 'Difference: ' + (expensesVariance >= 0 ? '+' : '') + '€' + expensesVariance.toLocaleString();
            expensesVarianceElement.style.color = expensesVariance <= 0 ? '#48bb78' : '#f56565'; // Negative is good for expenses
            
            const cashFlowVarianceElement = document.getElementById('cashFlowVariance');
            cashFlowVarianceElement.textContent = 'Difference: ' + (cashFlowVariance >= 0 ? '+' : '') + '€' + cashFlowVariance.toLocaleString();
            cashFlowVarianceElement.style.color = cashFlowVariance >= 0 ? '#48bb78' : '#f56565';
            
            // Update budget breakdown with 50/30/20 rule - totals and percentages
            document.getElementById('housingTotal').textContent = '€' + housingTotal.toFixed(2);
            document.getElementById('lifestyleTotal').textContent = '€' + lifestyleTotal.toFixed(2);
            document.getElementById('savingsTotal').textContent = '€' + savingsTotal.toFixed(2);
            
            document.getElementById('housingPercentage').textContent = housingPercentage.toFixed(1) + '% of expenses';
            document.getElementById('lifestylePercentage').textContent = lifestylePercentage.toFixed(1) + '% of expenses';
            document.getElementById('savingsPercentage').textContent = savingsPercentage.toFixed(1) + '% of expenses';
            
            // Calculate rule percentages (how much of the 50/30/20 target you're using)
            const housingRulePercentage = fiftyThirtyTwentyHousing > 0 ? (housingTotal / fiftyThirtyTwentyHousing * 100) : 0;
            const lifestyleRulePercentage = fiftyThirtyTwentyLifestyle > 0 ? (lifestyleTotal / fiftyThirtyTwentyLifestyle * 100) : 0;
            const savingsRulePercentage = fiftyThirtyTwentySavings > 0 ? (savingsTotal / fiftyThirtyTwentySavings * 100) : 0;
            
            document.getElementById('housingRulePercentage').textContent = housingRulePercentage.toFixed(1) + '% of rule target';
            document.getElementById('lifestyleRulePercentage').textContent = lifestyleRulePercentage.toFixed(1) + '% of rule target';
            document.getElementById('savingsRulePercentage').textContent = savingsRulePercentage.toFixed(1) + '% of rule target';
            
            // Update rule target displays in subsections
            document.getElementById('housingRuleTarget').textContent = '€' + fiftyThirtyTwentyHousing.toLocaleString();
            document.getElementById('lifestyleRuleTarget').textContent = '€' + fiftyThirtyTwentyLifestyle.toLocaleString();
            document.getElementById('savingsRuleTarget').textContent = '€' + fiftyThirtyTwentySavings.toLocaleString();
            
            // Update actual amounts in target sections
            document.getElementById('housingActualAmount').textContent = '€' + housingTotal.toFixed(2);
            document.getElementById('lifestyleActualAmount').textContent = '€' + lifestyleTotal.toFixed(2);
            document.getElementById('savingsActualAmount').textContent = '€' + savingsTotal.toFixed(2);
            
            // Update performance metrics in target sections
            const housingPercentOfIncome = totalIncome > 0 ? (housingTotal / totalIncome * 100).toFixed(1) : 0;
            const lifestylePercentOfIncome = totalIncome > 0 ? (lifestyleTotal / totalIncome * 100).toFixed(1) : 0;
            const savingsPercentOfIncome = totalIncome > 0 ? (savingsTotal / totalIncome * 100).toFixed(1) : 0;
            
            const housingPercentOfExpenses = totalExpenses > 0 ? (housingTotal / totalExpenses * 100).toFixed(1) : 0;
            const lifestylePercentOfExpenses = totalExpenses > 0 ? (lifestyleTotal / totalExpenses * 100).toFixed(1) : 0;
            const savingsPercentOfExpenses = totalExpenses > 0 ? (savingsTotal / totalExpenses * 100).toFixed(1) : 0;
            
            document.getElementById('housingPercentOfIncome').textContent = housingPercentOfIncome + '%';
            document.getElementById('lifestylePercentOfIncome').textContent = lifestylePercentOfIncome + '%';
            document.getElementById('savingsPercentOfIncome').textContent = savingsPercentOfIncome + '%';
            
            document.getElementById('housingPercentOfExpenses').textContent = housingPercentOfExpenses + '%';
            document.getElementById('lifestylePercentOfExpenses').textContent = lifestylePercentOfExpenses + '%';
            document.getElementById('savingsPercentOfExpenses').textContent = savingsPercentOfExpenses + '%';
            
            document.getElementById('housingPercentOfTarget').textContent = housingRulePercentage.toFixed(1) + '%';
            document.getElementById('lifestylePercentOfTarget').textContent = lifestyleRulePercentage.toFixed(1) + '%';
            document.getElementById('savingsPercentOfTarget').textContent = savingsRulePercentage.toFixed(1) + '%';
            
            // Update subsection breakdowns with euro amounts
            document.getElementById('housingRent').textContent = '€' + actualSpending['Rent/Housing'].toFixed(2);
            document.getElementById('housingUtilities').textContent = '€' + actualSpending['Utilities'].toFixed(2);
            document.getElementById('housingInsurance').textContent = '€' + actualSpending['Insurance'].toFixed(2);
            document.getElementById('housingInternet').textContent = '€' + actualSpending['Internet/Phone'].toFixed(2);
            
            document.getElementById('lifestyleGroceries').textContent = '€' + actualSpending['Groceries'].toFixed(2);
            document.getElementById('lifestyleEatingOut').textContent = '€' + actualSpending['Eating Out'].toFixed(2);
            document.getElementById('lifestyleTransportation').textContent = '€' + actualSpending['Transportation'].toFixed(2);
            document.getElementById('lifestyleEntertainment').textContent = '€' + actualSpending['Entertainment'].toFixed(2);
            document.getElementById('lifestyleShopping').textContent = '€' + actualSpending['Shopping'].toFixed(2);
            document.getElementById('lifestyleHobbies').textContent = '€' + actualSpending['Hobbies'].toFixed(2);
            document.getElementById('lifestyleMisc').textContent = '€' + actualSpending['Miscellaneous'].toFixed(2);
            
            // Show current bank balance as savings
            const currentBalanceDisplay = parseFloat(document.getElementById('currentBalance').value) || 0;
            document.getElementById('savingsTransactionsLabel').textContent = 'Current Bank Balance';
            document.getElementById('savingsTransactions').textContent = '€' + currentBalanceDisplay.toFixed(2);
            document.getElementById('savingsETF').textContent = 'ETF Investments (separate tracking)';
            
            // Update 50/30/20 rule
            document.getElementById('fiftyThirtyTwentyHousing').textContent = '€' + fiftyThirtyTwentyHousing.toLocaleString() + ' (50%)';
            document.getElementById('fiftyThirtyTwentyLifestyle').textContent = '€' + fiftyThirtyTwentyLifestyle.toLocaleString() + ' (30%)';
            document.getElementById('fiftyThirtyTwentySavings').textContent = '€' + fiftyThirtyTwentySavings.toLocaleString() + ' (20%)';
            
            // Update spending trends
            document.getElementById('biggestExpense').textContent = biggestExpense.name + ' (€' + biggestExpense.amount.toFixed(2) + ')';
            document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';
            document.getElementById('emergencyFundCoverage').textContent = emergencyFundCoverage.toFixed(1) + ' months';
            
                         // ETF metrics are now calculated and displayed in the ETF Portfolio tab
            
            // Calculate and display budget vs actual spending
            updateBudgetVsActual();
            
            // Update total monthly budget
            updateTotalMonthlyBudget();
            
            // Update charts if they exist
            updateCharts();
        }
        
        function updateBudgetVsActual() {
            // Get budget amounts
            const budgetRent = parseFloat(document.getElementById('budgetRent').value) || 0;
            const budgetUtilities = parseFloat(document.getElementById('budgetUtilities').value) || 0;
            const budgetGroceries = parseFloat(document.getElementById('budgetGroceries').value) || 0;
            const budgetEatingOut = parseFloat(document.getElementById('budgetEatingOut').value) || 0;
            const budgetTransportation = parseFloat(document.getElementById('budgetTransportation').value) || 0;
            const budgetEntertainment = parseFloat(document.getElementById('budgetEntertainment').value) || 0;
            const budgetShopping = parseFloat(document.getElementById('budgetShopping').value) || 0;
            const budgetHobbies = parseFloat(document.getElementById('budgetHobbies').value) || 0;
            const budgetInternet = parseFloat(document.getElementById('budgetInternet').value) || 0;
            const budgetInsurance = parseFloat(document.getElementById('budgetInsurance').value) || 0;
            const budgetMisc = parseFloat(document.getElementById('budgetMisc').value) || 0;
            const budgetETFInvestment = parseFloat(document.getElementById('budgetETFInvestment').value) || 0;
            
            // Calculate actual spending from transactions for selected month
            const viewDate = currentViewDate || new Date();
            const viewMonth = viewDate.getMonth();
            const viewYear = viewDate.getFullYear();
            
            const monthlyTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === viewMonth && transDate.getFullYear() === viewYear;
            });
            
            // Calculate actual spending by category
            const actualSpending = {
                'Rent/Housing': 0,
                'Utilities': 0,
                'Groceries': 0,
                'Eating Out': 0,
                'Transportation': 0,
                'Entertainment': 0,
                'Shopping': 0,
                'Savings': 0,
                'Hobbies': 0,
                'Internet/Phone': 0,
                'Insurance': 0,
                'ETF Investment': 0,
                'Miscellaneous': 0
            };
            
            monthlyTransactions.forEach(trans => {
                if (trans.category === 'Income') return; // Skip income
                
                // Map transaction categories to budget categories
                if (actualSpending.hasOwnProperty(trans.category)) {
                    actualSpending[trans.category] += parseFloat(trans.amount);
                }
            });
            
            // Update budget vs actual display - now with correct category mapping
            updateBudgetVsActualDisplay('rentHousing', budgetRent, actualSpending['Rent/Housing']);
            updateBudgetVsActualDisplay('utilities', budgetUtilities, actualSpending['Utilities']);
            updateBudgetVsActualDisplay('groceries', budgetGroceries, actualSpending['Groceries']);
            updateBudgetVsActualDisplay('eatingOut', budgetEatingOut, actualSpending['Eating Out']);
            updateBudgetVsActualDisplay('transportation', budgetTransportation, actualSpending['Transportation']);
            updateBudgetVsActualDisplay('entertainment', budgetEntertainment, actualSpending['Entertainment']);
            updateBudgetVsActualDisplay('shopping', budgetShopping, actualSpending['Shopping']);
            updateBudgetVsActualDisplay('hobbies', budgetHobbies, actualSpending['Hobbies']);
            updateBudgetVsActualDisplay('internetPhone', budgetInternet, actualSpending['Internet/Phone']);
            updateBudgetVsActualDisplay('insurance', budgetInsurance, actualSpending['Insurance']);
            updateBudgetVsActualDisplay('etfInvestment', budgetETFInvestment, actualSpending['ETF Investment']);
            updateBudgetVsActualDisplay('miscellaneous', budgetMisc, actualSpending['Miscellaneous']);
        }
        
        function updateBudgetVsActualDisplay(category, budget, actual) {
            const budgetElement = document.getElementById(category + 'BudgetVsActual');
            const statusElement = document.getElementById(category + 'Status');
            
            if (budgetElement && statusElement) {
                // Show Budget / Actual (correct order)
                budgetElement.textContent = `€${budget.toFixed(2)} / €${actual.toFixed(2)}`;
                
                if (budget === 0) {
                    statusElement.textContent = 'No Budget Set';
                    statusElement.style.color = '#718096';
                } else if (actual <= budget) {
                    statusElement.textContent = 'On Budget';
                    statusElement.style.color = '#48bb78';
                } else {
                    const overage = actual - budget;
                    statusElement.textContent = `€${overage.toFixed(2)} Over`;
                    statusElement.style.color = '#f56565';
                }
            }
        }
        
        function updateCharts() {
            if (!charts.budgetPie || !charts.cashFlow || !charts.budgetVsActual || !charts.totalBudgetVsExpenses) {
                console.log('Charts not ready yet, skipping update');
                return;
            }
            
            console.log('Updating charts with real data...');
            
            // Update Budget Breakdown Pie Chart
            const budgetRent = parseFloat(document.getElementById('budgetRent').value) || 0;
            const budgetUtilities = parseFloat(document.getElementById('budgetUtilities').value) || 0;
            const budgetTransportation = parseFloat(document.getElementById('budgetTransportation').value) || 0;
            const budgetGroceries = parseFloat(document.getElementById('budgetGroceries').value) || 0;
            const budgetEatingOut = parseFloat(document.getElementById('budgetEatingOut').value) || 0;
            const budgetEntertainment = parseFloat(document.getElementById('budgetEntertainment').value) || 0;
            const budgetShopping = parseFloat(document.getElementById('budgetShopping').value) || 0;
            const budgetHobbies = parseFloat(document.getElementById('budgetHobbies').value) || 0;
                         const budgetInternet = parseFloat(document.getElementById('budgetInternet').value) || 0;
             const budgetInsurance = parseFloat(document.getElementById('budgetInsurance').value) || 0;
             const budgetMisc = parseFloat(document.getElementById('budgetMisc').value) || 0;
             const budgetETFInvestment = parseFloat(document.getElementById('budgetETFInvestment').value) || 0;

             const totalBudget = budgetRent + budgetUtilities + budgetGroceries + budgetEatingOut + budgetTransportation + budgetEntertainment + budgetShopping + budgetHobbies + budgetInternet + budgetInsurance + budgetMisc;
             
                         // Update pie chart with ACTUAL spending (to match the cards)
            // Calculate actual spending from transactions for selected month
            const pieViewDate = currentViewDate || new Date();
            const pieViewMonth = pieViewDate.getMonth();
            const pieViewYear = pieViewDate.getFullYear();
            
            const pieMonthlyTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === pieViewMonth && transDate.getFullYear() === pieViewYear && trans.category !== 'Income';
            });
            
            const actualSpending = {
                'Rent/Housing': 0, 'Utilities': 0, 'Insurance': 0, 'Internet/Phone': 0,
                'Groceries': 0, 'Eating Out': 0, 'Transportation': 0, 'Entertainment': 0,
                'Shopping': 0, 'Hobbies': 0, 'Miscellaneous': 0, 'ETF Investment': 0, 'Savings': 0
            };
            
            pieMonthlyTransactions.forEach(trans => {
                if (actualSpending.hasOwnProperty(trans.category)) {
                    actualSpending[trans.category] += parseFloat(trans.amount);
                }
            });
            
            // Group actual spending by 50/30/20 rule
            const actualHousingTotal = actualSpending['Rent/Housing'] + actualSpending['Utilities'] + actualSpending['Insurance'] + actualSpending['Internet/Phone'];
            const actualLifestyleTotal = actualSpending['Groceries'] + actualSpending['Eating Out'] + actualSpending['Transportation'] + actualSpending['Entertainment'] + actualSpending['Shopping'] + actualSpending['Hobbies'] + actualSpending['Miscellaneous'];
            
            // Use current bank balance as savings (consistent with main logic)
            const currentBalanceChart = parseFloat(document.getElementById('currentBalance').value) || 0;
            const actualSavingsTotal = currentBalanceChart;
            
            // If all values are zero, show small default values to make chart visible
            const totalActualSpending = actualHousingTotal + actualLifestyleTotal + actualSavingsTotal;
            let chartData;
            if (totalActualSpending === 0) {
                chartData = [1, 1, 1]; // Small default values to show chart structure
            } else {
                chartData = [actualHousingTotal, actualLifestyleTotal, actualSavingsTotal];
            }
            
            charts.budgetPie.data.labels = ['Housing (50%)', 'Lifestyle (30%)', 'Savings (20%)'];
            charts.budgetPie.data.datasets[0].data = chartData;
            charts.budgetPie.update();
            

            
            // Update Cash Flow Chart
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            const totalMonthlyIncome = salary + otherIncome;
            
            // Calculate actual monthly expenses from transactions for selected month
            const cashViewDate = currentViewDate || new Date();
            const cashViewMonth = cashViewDate.getMonth();
            const cashViewYear = cashViewDate.getFullYear();
            
            const cashMonthlyTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === cashViewMonth && transDate.getFullYear() === cashViewYear && trans.category !== 'Income';
            });
            
            const totalMonthlyExpenses = cashMonthlyTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
            const netDifference = totalMonthlyIncome - totalMonthlyExpenses;
            
            // Calculate target values for chart
            const targetMonthlyIncome = totalMonthlyIncome; // Target income from budget
            const targetMonthlyExpenses = totalBudget; // Target expenses from total budget
            const targetNetCashFlow = targetMonthlyIncome - targetMonthlyExpenses; // Target net cash flow
            
            // Prepare chart data arrays for target and actual
            let targetData, actualData;
            if (totalMonthlyIncome === 0 && totalMonthlyExpenses === 0 && totalBudget === 0) {
                targetData = [1, 1, 0]; // Show default values for empty state
                actualData = [1, 1, 0];
            } else {
                targetData = [
                    targetMonthlyIncome || 1,
                    targetMonthlyExpenses || 1,
                    targetNetCashFlow
                ];
                actualData = [
                    totalMonthlyIncome || 1,
                    totalMonthlyExpenses || 1,
                    netDifference
                ];
            }
            
            charts.cashFlow.data.datasets[0].data = targetData; // Target dataset
            charts.cashFlow.data.datasets[1].data = actualData; // Actual dataset
            charts.cashFlow.update();
            
            // Update Budget vs Actual Chart
            if (charts.budgetVsActual) {
                const budgetRent = parseFloat(document.getElementById('budgetRent').value) || 0;
                const budgetUtilities = parseFloat(document.getElementById('budgetUtilities').value) || 0;
                const budgetGroceries = parseFloat(document.getElementById('budgetGroceries').value) || 0;
                const budgetEatingOut = parseFloat(document.getElementById('budgetEatingOut').value) || 0;
                const budgetTransportation = parseFloat(document.getElementById('budgetTransportation').value) || 0;
                const budgetEntertainment = parseFloat(document.getElementById('budgetEntertainment').value) || 0;
                const budgetShopping = parseFloat(document.getElementById('budgetShopping').value) || 0;
                const budgetHobbies = parseFloat(document.getElementById('budgetHobbies').value) || 0;
                const budgetInternet = parseFloat(document.getElementById('budgetInternet').value) || 0;
                const budgetInsurance = parseFloat(document.getElementById('budgetInsurance').value) || 0;
                const budgetMisc = parseFloat(document.getElementById('budgetMisc').value) || 0;
                const budgetETFInvestment = parseFloat(document.getElementById('budgetETFInvestment').value) || 0;
                
                // Calculate actual spending from transactions for selected month
                const budgetViewDate = currentViewDate || new Date();
                const budgetViewMonth = budgetViewDate.getMonth();
                const budgetViewYear = budgetViewDate.getFullYear();
                
                const monthlyTransactions = transactions.filter(trans => {
                    const transDate = new Date(trans.date);
                    return transDate.getMonth() === budgetViewMonth && transDate.getFullYear() === budgetViewYear;
                });
                
                const actualSpending = {
                    'Rent/Housing': 0,
                    'Utilities': 0,
                    'Groceries': 0,
                    'Eating Out': 0,
                    'Transportation': 0,
                    'Entertainment': 0,
                    'Shopping': 0,
                    'Savings': 0,
                    'Hobbies': 0,
                    'Internet/Phone': 0,
                    'Insurance': 0,
                    'ETF Investment': 0,
                    'Miscellaneous': 0
                };
                
                monthlyTransactions.forEach(trans => {
                    if (trans.category === 'Income') return;
                    if (actualSpending.hasOwnProperty(trans.category)) {
                        actualSpending[trans.category] += parseFloat(trans.amount);
                    }
                });
                
                const budgetData = [
                    budgetRent,
                    budgetUtilities,
                    budgetGroceries,
                    budgetEatingOut,
                    budgetTransportation,
                    budgetEntertainment,
                    budgetShopping,
                    budgetHobbies,
                    budgetInternet,
                    budgetInsurance,
                    budgetMisc,
                    budgetETFInvestment
                ];
                
                const actualData = [
                    actualSpending['Rent/Housing'],
                    actualSpending['Utilities'],
                    actualSpending['Groceries'],
                    actualSpending['Eating Out'],
                    actualSpending['Transportation'],
                    actualSpending['Entertainment'],
                    actualSpending['Shopping'],
                    actualSpending['Hobbies'],
                    actualSpending['Internet/Phone'],
                    actualSpending['Insurance'],
                    actualSpending['Miscellaneous'],
                    actualSpending['ETF Investment']
                ];
                
                charts.budgetVsActual.data.datasets[0].data = budgetData;
                charts.budgetVsActual.data.datasets[1].data = actualData;
                charts.budgetVsActual.update();
            }
            
            // Update Total Budget vs Total Expenses Chart
            if (charts.totalBudgetVsExpenses) {
                const totalMonthlyBudget = budgetRent + budgetUtilities + budgetGroceries + budgetEatingOut + budgetTransportation + budgetEntertainment + budgetShopping + budgetHobbies + budgetInternet + budgetInsurance + budgetMisc + budgetETFInvestment;
                
                // Calculate total expenses from selected month transactions
                const totalViewDate = currentViewDate || new Date();
                const totalViewMonth = totalViewDate.getMonth();
                const totalViewYear = totalViewDate.getFullYear();
                
                const monthlyTransactions = transactions.filter(trans => {
                    const transDate = new Date(trans.date);
                    return transDate.getMonth() === totalViewMonth && transDate.getFullYear() === totalViewYear && trans.category !== 'Income';
                });
                
                const totalMonthlyExpenses = monthlyTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
                
                // Update chart data
                charts.totalBudgetVsExpenses.data.datasets[0].data = [totalMonthlyBudget, totalMonthlyExpenses];
                charts.totalBudgetVsExpenses.update();
                
                // Update dashboard display values
                document.getElementById('dashboardTotalBudget').textContent = '€' + totalMonthlyBudget.toLocaleString();
                document.getElementById('dashboardTotalExpenses').textContent = '€' + totalMonthlyExpenses.toLocaleString();
                
                // Calculate and display remaining budget
                const remainingBudget = totalMonthlyBudget - totalMonthlyExpenses;
                const remainingBudgetElement = document.getElementById('remainingBudget');
                remainingBudgetElement.textContent = '€' + remainingBudget.toLocaleString();
                
                // Style remaining budget based on positive/negative
                if (remainingBudget >= 0) {
                    remainingBudgetElement.className = 'positive';
                } else {
                    remainingBudgetElement.className = 'negative';
                }
                
                // Update budget status
                const budgetStatus = document.getElementById('budgetStatus');
                if (totalMonthlyExpenses <= totalMonthlyBudget) {
                    budgetStatus.textContent = 'Under Budget';
                    budgetStatus.className = 'positive';
                } else {
                    budgetStatus.textContent = 'Over Budget';
                    budgetStatus.className = 'negative';
                }
            }
        }
        
        function saveData(silent = false) {
            const data = {
                budget: {
                    startingBalance: document.getElementById('startingBalance').value,
                    balanceAsOfDate: document.getElementById('balanceAsOfDate').value,
                    salary: document.getElementById('salary').value,
                    otherIncome: document.getElementById('otherIncome').value,
                    budgetRent: document.getElementById('budgetRent').value,
                    budgetUtilities: document.getElementById('budgetUtilities').value,
                    budgetGroceries: document.getElementById('budgetGroceries').value,
                    budgetEatingOut: document.getElementById('budgetEatingOut').value,
                    budgetTransportation: document.getElementById('budgetTransportation').value,
                    budgetEntertainment: document.getElementById('budgetEntertainment').value,
                    budgetShopping: document.getElementById('budgetShopping').value,
                    budgetHobbies: document.getElementById('budgetHobbies').value,
                    budgetInternet: document.getElementById('budgetInternet').value,
                                                              budgetInsurance: document.getElementById('budgetInsurance').value,
                     budgetMisc: document.getElementById('budgetMisc').value,
                     budgetETFInvestment: document.getElementById('budgetETFInvestment').value
                },

                transactions: transactions,
                etfTransactions: etfTransactions,
                lastModified: new Date().toISOString()
            };
            
            localStorage.setItem('financialTrackerData', JSON.stringify(data));
            if (!silent) {
                alert('Data saved successfully!');
            }
        }
        
        function loadData(silent = false) {
            const savedData = localStorage.getItem('financialTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Load budget data
                if (data.budget) {
                    Object.keys(data.budget).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data.budget[key] || '';
                        }
                    });
                }
                
                // Load transactions
                if (data.transactions) {
                    transactions = data.transactions;
                    displayTransactions();
                    checkAnalyticsAvailability(); // Check if analytics should be available
                }
                
                // Load ETF transactions
                if (data.etfTransactions) {
                    etfTransactions = data.etfTransactions;
                    displayETFTransactions();
                }
                
                // Update last modified
                if (data.lastModified) {
                    document.getElementById('lastModified').textContent = 
                        new Date(data.lastModified).toLocaleDateString('en-GB');
                }
                
                updateSummary();
                updateBankBalance();
                updateTotalMonthlyBudget();
                
                // Update charts after data is loaded
                setTimeout(() => {
                    updateCharts();
                }, 200);
                
                if (!silent) {
                    alert('Data loaded successfully!');
                }
            } else if (!silent) {
                alert('No saved data found.');
            }
        }
        
                 function clearAllData() {
             if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                 // Clear all input fields
                 const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
                 inputs.forEach(input => {
                     input.value = '';
                 });
                 
                                 // Clear transactions
                transactions = [];
                displayTransactions();
                checkAnalyticsAvailability(); // Check if analytics should be available
                 
                 // Clear ETF transactions
                 etfTransactions = [];
                 displayETFTransactions();
                 
                 // Clear local storage
                 localStorage.removeItem('financialTrackerData');
                 
                                 // Recalculate
                updateSummary();
                updateBankBalance();
                updateTotalMonthlyBudget();
                
                alert('All data has been cleared.');
             }
         }
        
        function exportToCSV() {
            let csv = 'Financial Tracker Export\n\n';
            
            // Bank Account Balance
            csv += 'BANK ACCOUNT BALANCE\n';
            csv += 'Starting Balance,€' + (document.getElementById('startingBalance').value || 0) + '\n';
            csv += 'Balance as of Date,' + (document.getElementById('balanceAsOfDate').value || 'Not Set') + '\n';
            csv += 'Current Balance,€' + (document.getElementById('currentBalance').value || 0) + '\n\n';
            
            // Monthly Budget
            csv += 'MONTHLY BUDGET\n';
            csv += 'Income\n';
            csv += 'Salary,€' + (document.getElementById('salary').value || 0) + '\n';
            csv += 'Other Income,€' + (document.getElementById('otherIncome').value || 0) + '\n\n';
            
            csv += 'Monthly Budget Categories\n';
            csv += 'Rent/Housing,€' + (document.getElementById('budgetRent').value || 0) + '\n';
            csv += 'Utilities,€' + (document.getElementById('budgetUtilities').value || 0) + '\n';
            csv += 'Groceries,€' + (document.getElementById('budgetGroceries').value || 0) + '\n';
            csv += 'Eating Out,€' + (document.getElementById('budgetEatingOut').value || 0) + '\n';
            csv += 'Transportation,€' + (document.getElementById('budgetTransportation').value || 0) + '\n';
            csv += 'Entertainment,€' + (document.getElementById('budgetEntertainment').value || 0) + '\n';
            csv += 'Shopping,€' + (document.getElementById('budgetShopping').value || 0) + '\n';
                         csv += 'Hobbies,€' + (document.getElementById('budgetHobbies').value || 0) + '\n';
             csv += 'Internet/Phone,€' + (document.getElementById('budgetInternet').value || 0) + '\n';
            csv += 'Insurance,€' + (document.getElementById('budgetInsurance').value || 0) + '\n';
            csv += 'Miscellaneous,€' + (document.getElementById('budgetMisc').value || 0) + '\n';
            csv += 'ETF Investment,€' + (document.getElementById('budgetETFInvestment').value || 0) + '\n\n';
            
                         csv += 'ETF Investment Tracking\n';
             csv += 'Current Total Portfolio Value,€' + (document.getElementById('currentTotalPortfolio').value || 0) + '\n';
             csv += 'Monthly Growth Rate,' + (document.getElementById('monthlyGrowthRate').value || 0) + '%\n\n';
            
            // Summary
            csv += 'SUMMARY\n';
            csv += 'Total Income,' + document.getElementById('totalIncome').textContent + '\n';
            csv += 'Total Expenses,' + document.getElementById('totalExpenses').textContent + '\n';
            csv += 'Net Cash Flow,' + document.getElementById('netCashFlow').textContent + '\n\n';
            

            
            // Transactions
            if (transactions.length > 0) {
                csv += 'TRANSACTIONS\n';
                csv += 'Date,Description,Category,Amount (€),Payment Method\n';
                transactions.forEach(t => {
                    // Format date to dd/mm/yyyy for CSV export
                    const dateObj = new Date(t.date);
                    const formattedDate = dateObj.toLocaleDateString('en-GB');
                    csv += `${formattedDate},${t.desc},${t.category},€${t.amount},${t.paymentMethod}\n`;
                });
            }
            
            // ETF Transactions
            if (etfTransactions.length > 0) {
                csv += '\nETF PORTFOLIO VALUES\n';
                csv += 'Date,Portfolio Value (€),Change (€),Growth Rate (%),Notes\n';
                etfTransactions.forEach(etf => {
                    // Format date to dd/mm/yyyy for CSV export
                    const dateObj = new Date(etf.date);
                    const formattedDate = dateObj.toLocaleDateString('en-GB');
                    csv += `${formattedDate},€${etf.value},,${etf.notes || ''}\n`;
                });
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_tracker_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }
        
        function downloadTemplate() {
            let csv = 'Financial Tracker Template - Fill in your data below\n\n';
            
            // Instructions
            csv += 'INSTRUCTIONS:\n';
            csv += '1. Fill in the sections below with your financial data\n';
            csv += '2. For transactions use format: DD/MM/YYYY,Description,Category,€Amount,Payment Method\n';
            csv += '3. Categories: Income,Rent/Housing,Utilities,Groceries,Eating Out,Transportation,Entertainment,Shopping,Hobbies,Internet/Phone,Insurance,Miscellaneous,ETF Investment\n';
            csv += '4. Payment Methods: Card,PayPal,Bank Transfer,Cash,Other\n';
            csv += '5. Save and import this file when ready\n\n';
            
            // Bank Account Balance Template
            csv += 'BANK ACCOUNT BALANCE\n';
            csv += 'Starting Balance,€0\n';
            csv += 'Balance as of Date,DD/MM/YYYY\n';
            csv += 'Current Balance,€0\n\n';
            
            // Monthly Budget Template
            csv += 'MONTHLY BUDGET\n';
            csv += 'Income\n';
            csv += 'Salary,€0\n';
            csv += 'Other Income,€0\n\n';
            
            csv += 'Monthly Budget Categories\n';
            csv += 'Rent/Housing,€0\n';
            csv += 'Utilities,€0\n';
            csv += 'Groceries,€0\n';
            csv += 'Eating Out,€0\n';
            csv += 'Transportation,€0\n';
            csv += 'Entertainment,€0\n';
            csv += 'Shopping,€0\n';
            csv += 'Hobbies,€0\n';
            csv += 'Internet/Phone,€0\n';
            csv += 'Insurance,€0\n';
            csv += 'Miscellaneous,€0\n';
            csv += 'ETF Investment,€0\n\n';
            
            // Transaction Template
            csv += 'TRANSACTIONS\n';
            csv += 'Date,Description,Category,Amount (€),Payment Method\n';
            csv += '# Add your transactions below (remove this line)\n';
            csv += '01/01/2024,Sample Transaction,Groceries,€25.50,Card\n';
            csv += '02/01/2024,Sample Income,Income,€1000.00,Bank Transfer\n\n';
            
            // ETF Portfolio Template
            csv += 'ETF PORTFOLIO VALUES\n';
            csv += 'Date,Portfolio Value (€),Change (€),Growth Rate (%),Notes\n';
            csv += '# Add your ETF data below (remove this line)\n';
            csv += '01/01/2024,€1000.00,,,Initial Investment\n';
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_tracker_template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    parseCSVData(csvContent);
                    alert('CSV imported successfully!');
                } catch (error) {
                    alert('Error importing CSV: ' + error.message + '\n\nPlease check your CSV format and try again.');
                    console.error('CSV Import Error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        function parseCSVData(csvContent) {
            const lines = csvContent.split('\n');
            let currentSection = '';
            let newTransactions = [];
            let newETFTransactions = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith('#')) continue;
                
                // Detect sections
                if (line === 'BANK ACCOUNT BALANCE') {
                    currentSection = 'BALANCE';
                    continue;
                } else if (line === 'MONTHLY BUDGET') {
                    currentSection = 'BUDGET';
                    continue;
                } else if (line === 'TRANSACTIONS') {
                    currentSection = 'TRANSACTIONS';
                    continue;
                } else if (line === 'ETF PORTFOLIO VALUES') {
                    currentSection = 'ETF';
                    continue;
                } else if (line === 'Income' || line === 'Monthly Budget Categories') {
                    continue;
                }
                
                const parts = line.split(',');
                
                if (currentSection === 'BALANCE') {
                    if (parts[0] === 'Starting Balance' && parts[1]) {
                        const value = parts[1].replace('€', '').trim();
                        document.getElementById('startingBalance').value = value;
                    } else if (parts[0] === 'Balance as of Date' && parts[1] && parts[1] !== 'Not Set') {
                        // Convert DD/MM/YYYY to YYYY-MM-DD for input
                        const dateStr = parts[1].trim();
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            document.getElementById('balanceAsOfDate').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    }
                } else if (currentSection === 'BUDGET') {
                    const budgetMapping = {
                        'Salary': 'salary',
                        'Other Income': 'otherIncome',
                        'Rent/Housing': 'budgetRent',
                        'Utilities': 'budgetUtilities',
                        'Groceries': 'budgetGroceries',
                        'Eating Out': 'budgetEatingOut',
                        'Transportation': 'budgetTransportation',
                        'Entertainment': 'budgetEntertainment',
                        'Shopping': 'budgetShopping',
                        'Hobbies': 'budgetHobbies',
                        'Internet/Phone': 'budgetInternet',
                        'Insurance': 'budgetInsurance',
                        'Miscellaneous': 'budgetMiscellaneous',
                        'ETF Investment': 'budgetETF'
                    };
                    
                    const fieldId = budgetMapping[parts[0]];
                    if (fieldId && parts[1]) {
                        const value = parts[1].replace('€', '').trim();
                        if (document.getElementById(fieldId)) {
                            document.getElementById(fieldId).value = value;
                        }
                    }
                } else if (currentSection === 'TRANSACTIONS' && parts.length >= 5) {
                    // Skip header row
                    if (parts[0] === 'Date') continue;
                    
                    const [dateStr, desc, category, amountStr, paymentMethod] = parts;
                    
                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    let date = dateStr.trim();
                    if (date.includes('/')) {
                        const [day, month, year] = date.split('/');
                        date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    const amount = parseFloat(amountStr.replace('€', '').trim());
                    
                    if (date && desc && category && !isNaN(amount) && paymentMethod) {
                        newTransactions.push({
                            date: date,
                            desc: desc.trim(),
                            category: category.trim(),
                            amount: amount,
                            paymentMethod: paymentMethod.trim()
                        });
                    }
                } else if (currentSection === 'ETF' && parts.length >= 2) {
                    // Skip header row
                    if (parts[0] === 'Date') continue;
                    
                    const [dateStr, valueStr, , , notes] = parts;
                    
                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    let date = dateStr.trim();
                    if (date.includes('/')) {
                        const [day, month, year] = date.split('/');
                        date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    const value = parseFloat(valueStr.replace('€', '').trim());
                    
                    if (date && !isNaN(value)) {
                        newETFTransactions.push({
                            date: date,
                            value: value,
                            notes: notes ? notes.trim() : ''
                        });
                    }
                }
            }
            
            // Add new transactions to existing ones
            if (newTransactions.length > 0) {
                transactions.push(...newTransactions);
                displayTransactions();
            }
            
            // Add new ETF transactions to existing ones
            if (newETFTransactions.length > 0) {
                etfTransactions.push(...newETFTransactions);
                // Sort by date
                etfTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                displayETFTransactions();
            }
            
            // Update displays
            updateSummary();
            updateBankBalance();
            updateTotalMonthlyBudget();
            checkAnalyticsAvailability();
            
            // Save the imported data
            saveData(true);
        }

        
        // Auto-save on input change (with debouncing)
        let saveTimeout;
        document.addEventListener('input', function(e) {
            if (e.target.type === 'number' || e.target.type === 'text') {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveData(true);
                }, 2000); // Auto-save after 2 seconds of no typing
            }
        });
        
        // Handle window resize for charts
        window.addEventListener('resize', function() {
            if (charts.budgetPie) charts.budgetPie.resize();
            if (charts.cashFlow) charts.cashFlow.resize();
            if (charts.budgetVsActual) charts.budgetVsActual.resize();
            if (charts.totalBudgetVsExpenses) charts.totalBudgetVsExpenses.resize();
            if (charts.historicalTrends) charts.historicalTrends.resize();
            if (charts.advancedAnalytics) charts.advancedAnalytics.resize();
            if (charts.healthScore) charts.healthScore.resize();
        });
        
        // Check if analytics should be available based on data
        function checkAnalyticsAvailability() {
            // Get unique months from transactions
            const months = new Set();
            transactions.forEach(trans => {
                const date = new Date(trans.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                months.add(monthKey);
            });
            
            const monthCount = months.size;
            const minMonthsRequired = 3;
            const hasEnoughData = monthCount >= minMonthsRequired;
            
            const analyticsTab = document.querySelector('.tab[onclick*="analytics"]');
            const analyticsContent = document.getElementById('analytics');
            
            // Update analytics tab visibility
            if (analyticsTab && analyticsContent) {
                if (hasEnoughData) {
                    // Show analytics tab
                    analyticsTab.style.display = 'block';
                    analyticsTab.disabled = false;
                    analyticsTab.style.opacity = '1';
                    analyticsTab.style.cursor = 'pointer';
                    
                    // Show normal welcome section
                    const welcomeSection = document.getElementById('analyticsWelcome');
                    const noticeSection = document.getElementById('insufficientDataNotice');
                    if (welcomeSection) welcomeSection.style.display = 'block';
                    if (noticeSection) noticeSection.style.display = 'none';
                    
                    // Hide analytics status indicator in dashboard
                    const analyticsStatus = document.getElementById('analyticsStatus');
                    if (analyticsStatus) analyticsStatus.style.display = 'none';
                } else {
                    // Hide analytics tab
                    analyticsTab.style.display = 'none';
                    
                    // If currently on analytics tab, switch to dashboard
                    if (analyticsContent.classList.contains('active')) {
                        switchTab('dashboard');
                    }
                    
                    // Show analytics status indicator in dashboard
                    const analyticsStatus = document.getElementById('analyticsStatus');
                    const monthsNeeded = document.getElementById('analyticsMonthsNeeded');
                    if (analyticsStatus && monthsNeeded) {
                        const remainingMonths = minMonthsRequired - monthCount;
                        analyticsStatus.style.display = 'block';
                        monthsNeeded.textContent = remainingMonths;
                        analyticsStatus.innerHTML = `📊 Analytics available with <span style="font-weight: bold; color: #667eea;">${remainingMonths} more month${remainingMonths !== 1 ? 's' : ''}</span> of data`;
                    }
                    
                    // Update progress if someone manually navigates to analytics (shouldn't happen but just in case)
                    updateAnalyticsProgress(monthCount, minMonthsRequired);
                }
            }
            
            return hasEnoughData;
        }
        
        // Update analytics progress display
        function updateAnalyticsProgress(currentMonths, requiredMonths) {
            const progressText = document.getElementById('dataProgressText');
            const progressBar = document.getElementById('dataProgressBar');
            
            if (progressText && progressBar) {
                const percentage = Math.min((currentMonths / requiredMonths) * 100, 100);
                
                progressText.textContent = `${currentMonths} month${currentMonths !== 1 ? 's' : ''}`;
                progressBar.style.width = `${percentage}%`;
                
                // Show insufficient data notice instead of welcome when not enough data
                const welcomeSection = document.getElementById('analyticsWelcome');
                const noticeSection = document.getElementById('insufficientDataNotice');
                
                if (currentMonths < requiredMonths) {
                    if (welcomeSection) welcomeSection.style.display = 'none';
                    if (noticeSection) noticeSection.style.display = 'block';
                } else {
                    if (welcomeSection) welcomeSection.style.display = 'block';
                    if (noticeSection) noticeSection.style.display = 'none';
                }
            }
        }
        
        // Debug function to check chart status
        function debugCharts() {
            console.log('Chart.js loaded:', typeof Chart !== 'undefined');
            console.log('Charts object:', charts);
            console.log('Canvas elements:');
            console.log('budgetPieChart:', document.getElementById('budgetPieChart'));
            console.log('spendingBarChart:', document.getElementById('spendingBarChart'));
            console.log('cashFlowChart:', document.getElementById('cashFlowChart'));
            console.log('budgetVsActualChart:', document.getElementById('budgetVsActualChart'));
            console.log('totalBudgetVsExpensesChart:', document.getElementById('totalBudgetVsExpensesChart'));
        }
        
        // Call debug function after a delay
        setTimeout(debugCharts, 1000);
        
        // Force update function for debugging
        function forceUpdateCharts() {
            console.log('Force updating all charts...');
            console.log('Charts object:', charts);
            updateCharts();
        }
        
        // Make it globally available for debugging
        window.forceUpdateCharts = forceUpdateCharts;
        
        // Phase 4: Month Navigation & Comparison Functions
        function initializeMonthSelectors() {
            const monthSelector = document.getElementById('monthSelector');
            const compareMonthSelector = document.getElementById('compareMonthSelector');
            
            if (!monthSelector || !compareMonthSelector) return;
            
            // Get available months from transactions
            const availableMonths = getAvailableMonths();
            
            // Clear existing options
            monthSelector.innerHTML = '';
            compareMonthSelector.innerHTML = '';
            
            // Populate month selectors
            availableMonths.forEach(month => {
                const option1 = document.createElement('option');
                option1.value = month.value;
                option1.textContent = month.label;
                monthSelector.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = month.value;
                option2.textContent = month.label;
                compareMonthSelector.appendChild(option2);
            });
            
            // Set current month as default
            const currentMonthValue = `${currentViewDate.getFullYear()}-${(currentViewDate.getMonth() + 1).toString().padStart(2, '0')}`;
            monthSelector.value = currentMonthValue;
            
            // Set previous month as default comparison
            const prevMonth = new Date(currentViewDate);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const prevMonthValue = `${prevMonth.getFullYear()}-${(prevMonth.getMonth() + 1).toString().padStart(2, '0')}`;
            compareMonthSelector.value = prevMonthValue;
            compareDate = prevMonth;
        }
        
        function getAvailableMonths() {
            const months = new Set();
            
            // Add months from transactions
            transactions.forEach(trans => {
                const date = new Date(trans.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                months.add(monthKey);
            });
            
            // Add current month if no transactions exist
            if (months.size === 0) {
                const current = new Date();
                const monthKey = `${current.getFullYear()}-${(current.getMonth() + 1).toString().padStart(2, '0')}`;
                months.add(monthKey);
            }
            
            // Convert to array and sort
            const sortedMonths = Array.from(months).sort().reverse();
            
            // Convert to label format
            return sortedMonths.map(monthKey => {
                const [year, month] = monthKey.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1);
                const label = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                return { value: monthKey, label: label };
            });
        }
        
        function changeMonth(direction) {
            const newDate = new Date(currentViewDate);
            newDate.setMonth(newDate.getMonth() + direction);
            currentViewDate = newDate;
            
            // Update selector
            const monthSelector = document.getElementById('monthSelector');
            const monthValue = `${newDate.getFullYear()}-${(newDate.getMonth() + 1).toString().padStart(2, '0')}`;
            monthSelector.value = monthValue;
            
            // Update dashboard
            updateDashboardForMonth();
        }
        
        function selectMonth() {
            const monthSelector = document.getElementById('monthSelector');
            const selectedValue = monthSelector.value;
            const [year, month] = selectedValue.split('-');
            
            currentViewDate = new Date(parseInt(year), parseInt(month) - 1);
            updateDashboardForMonth();
        }
        
        function toggleComparisonMode() {
            comparisonMode = !comparisonMode;
            const toggleBtn = document.getElementById('toggleComparison');
            const compareSelector = document.getElementById('compareMonthSelector');
            const comparisonSummary = document.getElementById('comparisonSummary');
            
            if (comparisonMode) {
                toggleBtn.textContent = 'Disable Comparison';
                toggleBtn.style.background = '#f56565';
                compareSelector.style.display = 'block';
                comparisonSummary.style.display = 'block';
                updateComparison();
            } else {
                toggleBtn.textContent = 'Enable Comparison';
                toggleBtn.style.background = '#48bb78';
                compareSelector.style.display = 'none';
                comparisonSummary.style.display = 'none';
            }
        }
        
        function updateComparison() {
            if (!comparisonMode) return;
            
            const compareSelector = document.getElementById('compareMonthSelector');
            const selectedValue = compareSelector.value;
            const [year, month] = selectedValue.split('-');
            
            compareDate = new Date(parseInt(year), parseInt(month) - 1);
            
            // Calculate comparison data
            const currentData = getMonthlyData(currentViewDate);
            const compareData = getMonthlyData(compareDate);
            
            // Update comparison display
            updateComparisonDisplay(currentData, compareData);
        }
        
        function getMonthlyData(date) {
            const month = date.getMonth();
            const year = date.getFullYear();
            
            // Filter transactions for the month
            const monthTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === month && transDate.getFullYear() === year;
            });
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpenses = 0;
            
            monthTransactions.forEach(trans => {
                if (trans.category === 'Income') {
                    totalIncome += parseFloat(trans.amount);
                } else {
                    totalExpenses += parseFloat(trans.amount);
                }
            });
            
            return {
                date: date,
                totalIncome: totalIncome,
                totalExpenses: totalExpenses,
                netCashFlow: totalIncome - totalExpenses,
                transactionCount: monthTransactions.length,
                transactions: monthTransactions
            };
        }
        
        function updateComparisonDisplay(currentData, compareData) {
            const currentMonthLabel = document.getElementById('currentMonthLabel');
            const compareMonthLabel = document.getElementById('compareMonthLabel');
            const currentMonthData = document.getElementById('currentMonthData');
            const compareMonthData = document.getElementById('compareMonthData');
            const monthDifference = document.getElementById('monthDifference');
            
            // Update labels
            currentMonthLabel.textContent = currentData.date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            compareMonthLabel.textContent = compareData.date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            
            // Update data (showing total expenses for comparison)
            currentMonthData.textContent = '€' + currentData.totalExpenses.toLocaleString();
            compareMonthData.textContent = '€' + compareData.totalExpenses.toLocaleString();
            
            // Calculate and display difference
            const difference = currentData.totalExpenses - compareData.totalExpenses;
            monthDifference.textContent = (difference >= 0 ? '+' : '') + '€' + difference.toLocaleString();
            monthDifference.style.color = difference >= 0 ? '#f56565' : '#48bb78'; // Red if higher expenses, green if lower
        }
        
        function updateDashboardForMonth() {
            // Update all dashboard sections to show data for the selected month
            // This will override the current month logic in existing functions
            updateSummary();
            updateCharts();
            
            if (comparisonMode) {
                updateComparison();
            }
        }
        
        function resetToCurrentMonth() {
            currentViewDate = new Date();
            const monthSelector = document.getElementById('monthSelector');
            const currentMonthValue = `${currentViewDate.getFullYear()}-${(currentViewDate.getMonth() + 1).toString().padStart(2, '0')}`;
            monthSelector.value = currentMonthValue;
            updateDashboardForMonth();
        }
        
        function exportMonthlyReport() {
            const monthData = getMonthlyData(currentViewDate);
            const monthName = currentViewDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            
            let csv = `Monthly Financial Report - ${monthName}\n\n`;
            csv += `Report Generated: ${new Date().toLocaleDateString('en-GB')}\n\n`;
            csv += `MONTH SUMMARY\n`;
            csv += `Total Income,€${monthData.totalIncome.toFixed(2)}\n`;
            csv += `Total Expenses,€${monthData.totalExpenses.toFixed(2)}\n`;
            csv += `Net Cash Flow,€${monthData.netCashFlow.toFixed(2)}\n`;
            csv += `Transaction Count,${monthData.transactionCount}\n\n`;
            
            csv += `TRANSACTIONS\n`;
            csv += `Date,Description,Category,Amount (€),Payment Method\n`;
            monthData.transactions.forEach(trans => {
                const dateObj = new Date(trans.date);
                const formattedDate = dateObj.toLocaleDateString('en-GB');
                csv += `${formattedDate},${trans.desc},${trans.category},€${trans.amount},${trans.paymentMethod}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial_report_${monthName.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // Transaction Filtering Functions
        function initializeTransactionFilters() {
            const transactionMonthSelector = document.getElementById('transactionMonthSelector');
            
            if (!transactionMonthSelector) return;
            
            // Get available months from transactions
            const availableMonths = getAvailableMonths();
            
            // Clear existing options
            transactionMonthSelector.innerHTML = '';
            
            // Add "All Time" option
            const allTimeOption = document.createElement('option');
            allTimeOption.value = 'all';
            allTimeOption.textContent = 'All Time';
            transactionMonthSelector.appendChild(allTimeOption);
            
            // Populate month options
            availableMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                transactionMonthSelector.appendChild(option);
            });
            
            // Set default to all time
            transactionMonthSelector.value = 'all';
            transactionViewDate = null;
            
            // Initialize sort indicators
            updateSortIndicators();
        }
        
        function getFilteredTransactions() {
            let filtered = transactions;
            
            // Apply month filter
            if (transactionViewDate) {
                const viewMonth = transactionViewDate.getMonth();
                const viewYear = transactionViewDate.getFullYear();
                
                filtered = filtered.filter(trans => {
                    const transDate = new Date(trans.date);
                    return transDate.getMonth() === viewMonth && transDate.getFullYear() === viewYear;
                });
            }
            
            // Apply category filter
            if (transactionCategoryFilter !== 'all') {
                filtered = filtered.filter(trans => trans.category === transactionCategoryFilter);
            }
            
            return filtered;
        }
        
        function filterTransactionsByMonth() {
            const monthSelector = document.getElementById('transactionMonthSelector');
            const categoryFilter = document.getElementById('transactionCategoryFilter');
            
            // Update month filter
            if (monthSelector.value === 'all') {
                transactionViewDate = null;
            } else {
                const [year, month] = monthSelector.value.split('-');
                transactionViewDate = new Date(parseInt(year), parseInt(month) - 1);
            }
            
            // Update category filter
            transactionCategoryFilter = categoryFilter.value;
            
            // Refresh display
            displayTransactions();
        }
        
        function changeTransactionMonth(direction) {
            const monthSelector = document.getElementById('transactionMonthSelector');
            
            if (monthSelector.value === 'all') {
                // If currently showing all time, start from current month
                const currentDate = new Date();
                transactionViewDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + direction);
            } else {
                // Navigate from current selection
                const newDate = new Date(transactionViewDate);
                newDate.setMonth(newDate.getMonth() + direction);
                transactionViewDate = newDate;
            }
            
            // Update selector
            const monthValue = `${transactionViewDate.getFullYear()}-${(transactionViewDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // Check if this month exists in the dropdown
            const optionExists = Array.from(monthSelector.options).some(option => option.value === monthValue);
            if (optionExists) {
                monthSelector.value = monthValue;
            } else {
                // If month doesn't exist, show all time
                monthSelector.value = 'all';
                transactionViewDate = null;
            }
            
            // Refresh display
            displayTransactions();
        }
        
        function resetTransactionFilters() {
            // Reset to all time and all categories
            const monthSelector = document.getElementById('transactionMonthSelector');
            const categoryFilter = document.getElementById('transactionCategoryFilter');
            
            monthSelector.value = 'all';
            categoryFilter.value = 'all';
            
            transactionViewDate = null;
            transactionCategoryFilter = 'all';
            
            // Refresh display
            displayTransactions();
        }
        
        function exportTransactionMonth() {
            const filteredTransactions = getFilteredTransactions();
            
            let filterDescription = 'All Time';
            if (transactionViewDate) {
                filterDescription = transactionViewDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            }
            if (transactionCategoryFilter !== 'all') {
                filterDescription += ` - ${transactionCategoryFilter} Category`;
            }
            
            let csv = `Transaction Export - ${filterDescription}\n\n`;
            csv += `Export Generated: ${new Date().toLocaleDateString('en-GB')}\n\n`;
            csv += `SUMMARY\n`;
            
            let totalIncome = 0, totalExpenses = 0;
            filteredTransactions.forEach(trans => {
                if (trans.category === 'Income') {
                    totalIncome += parseFloat(trans.amount);
                } else {
                    totalExpenses += parseFloat(trans.amount);
                }
            });
            
            csv += `Total Transactions,${filteredTransactions.length}\n`;
            csv += `Total Income,€${totalIncome.toFixed(2)}\n`;
            csv += `Total Expenses,€${totalExpenses.toFixed(2)}\n`;
            csv += `Net Amount,€${(totalIncome - totalExpenses).toFixed(2)}\n\n`;
            
            csv += `TRANSACTIONS\n`;
            csv += `Date,Description,Category,Amount (€),Payment Method\n`;
            filteredTransactions.forEach(trans => {
                const dateObj = new Date(trans.date);
                const formattedDate = dateObj.toLocaleDateString('en-GB');
                csv += `${formattedDate},${trans.desc},${trans.category},€${trans.amount},${trans.paymentMethod}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${filterDescription.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function updateTransactionFilterStatus(filteredCount, totalCount) {
            const statusElement = document.getElementById('transactionFilterStatus');
            
            if (filteredCount === totalCount) {
                statusElement.textContent = 'Showing all transactions';
            } else {
                let filterText = `Showing ${filteredCount} of ${totalCount} transactions`;
                
                if (transactionViewDate) {
                    const monthName = transactionViewDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    filterText += ` for ${monthName}`;
                }
                
                if (transactionCategoryFilter !== 'all') {
                    filterText += ` in ${transactionCategoryFilter} category`;
                }
                
                statusElement.textContent = filterText;
            }
        }
        
        // Transaction Sorting Functions
        function sortTransactions(column) {
            // If clicking the same column, toggle direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Update sort indicators
            updateSortIndicators();
            
            // Re-display transactions with new sorting
            displayTransactions();
        }
        
        function updateSortIndicators() {
            // Reset all indicators
            const indicators = document.querySelectorAll('.sort-indicator');
            indicators.forEach(indicator => {
                indicator.textContent = '-';
            });
            
            // Set current sort indicator
            const currentIndicator = document.getElementById(`sort-${currentSortColumn}`);
            if (currentIndicator) {
                currentIndicator.textContent = currentSortDirection === 'asc' ? '▲' : '▼';
            }
        }
        
        function getSortedTransactions(transactions) {
            if (!transactions || transactions.length === 0) return [];
            
            return [...transactions].sort((a, b) => {
                let aValue, bValue;
                
                switch (currentSortColumn) {
                    case 'date':
                        aValue = new Date(a.date);
                        bValue = new Date(b.date);
                        break;
                    case 'desc':
                        aValue = a.desc.toLowerCase();
                        bValue = b.desc.toLowerCase();
                        break;
                    case 'category':
                        aValue = a.category.toLowerCase();
                        bValue = b.category.toLowerCase();
                        break;
                    case 'amount':
                        aValue = parseFloat(a.amount);
                        bValue = parseFloat(b.amount);
                        break;
                    case 'paymentMethod':
                        aValue = a.paymentMethod.toLowerCase();
                        bValue = b.paymentMethod.toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                // Handle string comparison
                if (typeof aValue === 'string') {
                    if (currentSortDirection === 'asc') {
                        return aValue.localeCompare(bValue);
                    } else {
                        return bValue.localeCompare(aValue);
                    }
                }
                
                // Handle number/date comparison
                if (currentSortDirection === 'asc') {
                    return aValue - bValue;
                } else {
                    return bValue - aValue;
                }
            });
        }
        
        // Historical Trends Functions
        function updateHistoricalTrends() {
            if (!charts.historicalTrends) return;
            
            const analysisPeriod = document.getElementById('trendsAnalysisPeriod').value;
            const categoryFocus = document.getElementById('trendsCategoryFocus').value;
            const viewType = document.getElementById('trendsViewType').value;
            
            // Get historical data
            const historicalData = getHistoricalData(analysisPeriod, categoryFocus, viewType);
            
            // Update chart
            updateTrendsChart(historicalData, viewType);
            
            // Update trend insights
            updateTrendInsights(historicalData, viewType, analysisPeriod);
            
            // Update pattern analysis
            updatePatternAnalysis(historicalData, viewType, categoryFocus);
        }
        
        function getHistoricalData(period, category, viewType) {
            const currentDate = new Date();
            let startDate = new Date();
            
            // Calculate start date based on period
            if (period === 'all') {
                startDate = new Date(Math.min(...transactions.map(t => new Date(t.date))));
            } else {
                startDate.setMonth(currentDate.getMonth() - parseInt(period));
            }
            
            // Group transactions by month
            const monthlyData = {};
            
            transactions.forEach(trans => {
                const transDate = new Date(trans.date);
                if (transDate >= startDate && transDate <= currentDate) {
                    const monthKey = `${transDate.getFullYear()}-${(transDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { income: 0, expenses: 0, categories: {} };
                    }
                    
                    if (trans.category === 'Income') {
                        monthlyData[monthKey].income += parseFloat(trans.amount);
                    } else {
                        monthlyData[monthKey].expenses += parseFloat(trans.amount);
                        
                        if (!monthlyData[monthKey].categories[trans.category]) {
                            monthlyData[monthKey].categories[trans.category] = 0;
                        }
                        monthlyData[monthKey].categories[trans.category] += parseFloat(trans.amount);
                    }
                }
            });
            
            // Convert to arrays for chart
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(parseInt(year), parseInt(monthNum) - 1);
                return date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
            });
            
            const values = sortedMonths.map(month => {
                const data = monthlyData[month];
                switch (viewType) {
                    case 'income':
                        return data.income;
                    case 'spending':
                        if (category === 'all') {
                            return data.expenses;
                        } else {
                            return data.categories[category] || 0;
                        }
                    case 'cashflow':
                        return data.income - data.expenses;
                    case 'savings':
                        return data.income > 0 ? ((data.income - data.expenses) / data.income * 100) : 0;
                    default:
                        return data.expenses;
                }
            });
            
            return { labels, values, monthlyData: monthlyData };
        }
        
        function updateTrendsChart(data, viewType) {
            const chart = charts.historicalTrends;
            
            // Update chart data
            chart.data.labels = data.labels;
            chart.data.datasets[0].data = data.values;
            
            // Update chart label and color based on view type
            let label, color;
            switch (viewType) {
                case 'income':
                    label = 'Monthly Income';
                    color = '#10b981';
                    break;
                case 'spending':
                    label = 'Monthly Spending';
                    color = '#f59e0b';
                    break;
                case 'cashflow':
                    label = 'Net Cash Flow';
                    color = '#8b5cf6';
                    break;
                case 'savings':
                    label = 'Savings Rate (%)';
                    color = '#06b6d4';
                    break;
                default:
                    label = 'Monthly Spending';
                    color = '#667eea';
            }
            
            chart.data.datasets[0].label = label;
            chart.data.datasets[0].borderColor = color;
            chart.data.datasets[0].backgroundColor = color + '20';
            
            chart.update();
        }
        
        function updateTrendInsights(data, viewType, period) {
            const values = data.values;
            if (values.length === 0) return;
            
            // Calculate trend direction
            const first = values[0];
            const last = values[values.length - 1];
            const change = last - first;
            const changePercent = first !== 0 ? (change / first * 100) : 0;
            
            // Update trend direction
            const trendDirection = document.getElementById('trendDirection');
            const trendPercentage = document.getElementById('trendPercentage');
            
            if (Math.abs(changePercent) < 5) {
                trendDirection.textContent = '📈 Stable';
                trendDirection.style.color = '#6b7280';
            } else if (changePercent > 0) {
                if (viewType === 'income' || viewType === 'savings') {
                    trendDirection.textContent = '📈 Increasing';
                    trendDirection.style.color = '#10b981';
                } else {
                    trendDirection.textContent = '📈 Increasing';
                    trendDirection.style.color = '#f59e0b';
                }
            } else {
                if (viewType === 'income' || viewType === 'savings') {
                    trendDirection.textContent = '📉 Decreasing';
                    trendDirection.style.color = '#ef4444';
                } else {
                    trendDirection.textContent = '📉 Decreasing';
                    trendDirection.style.color = '#10b981';
                }
            }
            
            trendPercentage.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}% change`;
            
            // Update average
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            const trendAverage = document.getElementById('trendAverage');
            if (viewType === 'savings') {
                trendAverage.textContent = average.toFixed(1) + '%';
            } else {
                trendAverage.textContent = '€' + average.toLocaleString();
            }
            
            document.getElementById('trendPeriodInfo').textContent = `Last ${period === 'all' ? values.length : period} months`;
            
            // Update peak and lowest
            const maxIndex = values.indexOf(Math.max(...values));
            const minIndex = values.indexOf(Math.min(...values));
            
            const trendPeak = document.getElementById('trendPeak');
            const trendLowest = document.getElementById('trendLowest');
            
            if (viewType === 'savings') {
                trendPeak.textContent = values[maxIndex].toFixed(1) + '%';
                trendLowest.textContent = values[minIndex].toFixed(1) + '%';
            } else {
                trendPeak.textContent = '€' + values[maxIndex].toLocaleString();
                trendLowest.textContent = '€' + values[minIndex].toLocaleString();
            }
            
            document.getElementById('trendPeakMonth').textContent = data.labels[maxIndex];
            document.getElementById('trendLowestMonth').textContent = data.labels[minIndex];
        }
        
        function updatePatternAnalysis(data, viewType, category) {
            const patternElement = document.getElementById('patternAnalysis');
            
            if (data.values.length < 3) {
                patternElement.innerHTML = '<p>📊 Need at least 3 months of data to analyze patterns.</p>';
                return;
            }
            
            const values = data.values;
            let analysis = '';
            
            // Volatility analysis
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) / values.length;
            const volatility = Math.sqrt(variance) / average * 100;
            
            if (volatility < 10) {
                analysis += '<p>📊 <strong>Stability:</strong> Your spending shows consistent patterns with low volatility.</p>';
            } else if (volatility < 25) {
                analysis += '<p>📊 <strong>Moderate Variation:</strong> Some fluctuation in your spending patterns is normal.</p>';
            } else {
                analysis += '<p>📊 <strong>High Volatility:</strong> Consider reviewing what causes large spending variations.</p>';
            }
            
            // Trend analysis
            const recentAverage = values.slice(-3).reduce((sum, val) => sum + val, 0) / 3;
            const earlyAverage = values.slice(0, 3).reduce((sum, val) => sum + val, 0) / 3;
            const trendStrength = Math.abs(recentAverage - earlyAverage) / earlyAverage * 100;
            
            if (trendStrength > 15) {
                if (recentAverage > earlyAverage) {
                    if (viewType === 'income') {
                        analysis += '<p>💰 <strong>Income Growth:</strong> Your income shows an upward trend - great progress!</p>';
                    } else {
                        analysis += '<p>⚠️ <strong>Spending Increase:</strong> Recent months show higher spending. Review budget adherence.</p>';
                    }
                } else {
                    if (viewType === 'income') {
                        analysis += '<p>⚠️ <strong>Income Decline:</strong> Consider income diversification strategies.</p>';
                    } else {
                        analysis += '<p>✅ <strong>Spending Reduction:</strong> Excellent cost control in recent months!</p>';
                    }
                }
            }
            
            // Seasonal patterns (if enough data)
            if (values.length >= 6) {
                const maxMonth = values.indexOf(Math.max(...values));
                const minMonth = values.indexOf(Math.min(...values));
                analysis += `<p>📅 <strong>Seasonal Pattern:</strong> Peak in ${data.labels[maxMonth]}, lowest in ${data.labels[minMonth]}.</p>`;
            }
            
            // Category-specific insights
            if (category !== 'all') {
                analysis += `<p>🏷️ <strong>Category Focus:</strong> Analyzing ${category} spending specifically provides targeted insights for budget optimization.</p>`;
            }
            
            patternElement.innerHTML = analysis || '<p>📊 Continue tracking to build more comprehensive pattern analysis.</p>';
        }
        
        // Advanced Analytics Functions
        function updateAdvancedAnalytics() {
            if (!charts.advancedAnalytics || !charts.healthScore) return;
            
            const analyticsType = document.getElementById('analyticsType').value;
            const forecastPeriod = document.getElementById('forecastPeriod').value;
            
            switch (analyticsType) {
                case 'forecasting':
                    updateSpendingForecast(forecastPeriod);
                    break;
                case 'variance':
                    updateVarianceAnalysis();
                    break;
                case 'seasonal':
                    updateSeasonalAnalysis();
                    break;
                case 'efficiency':
                    updateEfficiencyAnalysis();
                    break;
            }
            
            // Update financial health score
            updateFinancialHealthScore();
            
            // Update recommendations
            updateSmartRecommendations(analyticsType);
        }
        
        function updateSpendingForecast(forecastPeriod) {
            const chart = charts.advancedAnalytics;
            
            // Get last 6 months of data for forecasting
            const historicalData = getHistoricalData(6, 'all', 'spending');
            const values = historicalData.values;
            
            if (values.length < 3) {
                chart.data.labels = ['Insufficient Data'];
                chart.data.datasets[0].data = [0];
                chart.data.datasets[1].data = [0];
                chart.update();
                return;
            }
            
            // Simple linear regression for forecasting
            const n = values.length;
            const sumX = (n * (n + 1)) / 2;
            const sumY = values.reduce((sum, val) => sum + val, 0);
            const sumXY = values.reduce((sum, val, index) => sum + val * (index + 1), 0);
            const sumX2 = (n * (n + 1) * (2 * n + 1)) / 6;
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Generate forecast
            const forecastValues = [];
            const forecastMonths = parseInt(forecastPeriod);
            
            for (let i = 1; i <= forecastMonths; i++) {
                const predicted = slope * (n + i) + intercept;
                forecastValues.push(Math.max(0, predicted)); // Ensure non-negative
            }
            
            // Generate labels
            const currentDate = new Date();
            const labels = [];
            const historicalLabels = [];
            
            // Historical labels
            for (let i = values.length - 1; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setMonth(date.getMonth() - i);
                historicalLabels.push(date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }));
            }
            
            // Forecast labels
            for (let i = 1; i <= forecastMonths; i++) {
                const date = new Date(currentDate);
                date.setMonth(date.getMonth() + i);
                labels.push(date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }));
            }
            
            // Update chart
            chart.data.labels = [...historicalLabels, ...labels];
            chart.data.datasets[0].data = [...values, ...Array(forecastMonths).fill(null)];
            chart.data.datasets[1].data = [...Array(values.length).fill(null), ...forecastValues];
            chart.update();
            
            // Update prediction display
            const nextMonthPrediction = forecastValues[0] || 0;
            document.getElementById('predictedSpending').textContent = '€' + nextMonthPrediction.toLocaleString();
            
            // Calculate confidence
            const avgError = values.reduce((sum, val, index) => {
                const predicted = slope * (index + 1) + intercept;
                return sum + Math.abs(val - predicted);
            }, 0) / values.length;
            
            const confidence = Math.max(0, 100 - (avgError / (sumY / n) * 100));
            document.getElementById('predictionConfidence').textContent = `${confidence.toFixed(0)}% confidence`;
        }
        
        function updateVarianceAnalysis() {
            // Implementation for budget variance analysis
            const budgetTotal = parseFloat(document.getElementById('budgetRent').value || 0) +
                              parseFloat(document.getElementById('budgetUtilities').value || 0) +
                              parseFloat(document.getElementById('budgetGroceries').value || 0) +
                              parseFloat(document.getElementById('budgetEatingOut').value || 0) +
                              parseFloat(document.getElementById('budgetTransportation').value || 0) +
                              parseFloat(document.getElementById('budgetEntertainment').value || 0) +
                              parseFloat(document.getElementById('budgetShopping').value || 0) +
                              parseFloat(document.getElementById('budgetHobbies').value || 0) +
                              parseFloat(document.getElementById('budgetInternet').value || 0) +
                              parseFloat(document.getElementById('budgetInsurance').value || 0) +
                              parseFloat(document.getElementById('budgetMisc').value || 0) +
                              parseFloat(document.getElementById('budgetETFInvestment').value || 0);
            
            // Get current month actual spending
            const currentDate = new Date();
            const currentMonthTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === currentDate.getMonth() &&
                       transDate.getFullYear() === currentDate.getFullYear() &&
                       trans.category !== 'Income';
            });
            
            const actualTotal = currentMonthTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
            const variance = ((actualTotal - budgetTotal) / budgetTotal) * 100;
            
            document.getElementById('budgetEfficiency').textContent = Math.abs(variance).toFixed(1) + '%';
            document.getElementById('efficiencyTrend').textContent = variance > 0 ? 'Over Budget' : 'Under Budget';
        }
        
        function updateSeasonalAnalysis() {
            // Implementation for seasonal pattern analysis
            document.getElementById('predictedSpending').textContent = 'Seasonal Analysis';
            document.getElementById('predictionConfidence').textContent = 'Pattern based';
        }
        
        function updateEfficiencyAnalysis() {
            // Implementation for financial efficiency analysis
            document.getElementById('predictedSpending').textContent = 'Efficiency Score';
            document.getElementById('predictionConfidence').textContent = 'Multi-factor';
        }
        
        function updateFinancialHealthScore() {
            if (!charts.healthScore) return;
            
            // Calculate health score based on multiple factors
            let score = 0;
            let factors = 0;
            
            // Factor 1: Budget adherence (25 points)
            const currentDate = new Date();
            const currentMonthTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === currentDate.getMonth() &&
                       transDate.getFullYear() === currentDate.getFullYear() &&
                       trans.category !== 'Income';
            });
            
            const actualSpending = currentMonthTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
            const totalBudget = parseFloat(document.getElementById('budgetRent').value || 0) +
                              parseFloat(document.getElementById('budgetUtilities').value || 0) +
                              parseFloat(document.getElementById('budgetGroceries').value || 0) +
                              parseFloat(document.getElementById('budgetEatingOut').value || 0) +
                              parseFloat(document.getElementById('budgetTransportation').value || 0) +
                              parseFloat(document.getElementById('budgetEntertainment').value || 0) +
                              parseFloat(document.getElementById('budgetShopping').value || 0) +
                              parseFloat(document.getElementById('budgetHobbies').value || 0) +
                              parseFloat(document.getElementById('budgetInternet').value || 0) +
                              parseFloat(document.getElementById('budgetInsurance').value || 0) +
                              parseFloat(document.getElementById('budgetMisc').value || 0) +
                              parseFloat(document.getElementById('budgetETFInvestment').value || 0);
            
            if (totalBudget > 0) {
                const budgetAdherence = Math.max(0, 25 - Math.abs(actualSpending - totalBudget) / totalBudget * 25);
                score += budgetAdherence;
                factors++;
            }
            
            // Factor 2: Savings rate (25 points)
            const currentBalance = parseFloat(document.getElementById('currentBalance').value || 0);
            const totalIncome = parseFloat(document.getElementById('salary').value || 0) + parseFloat(document.getElementById('otherIncome').value || 0);
            
            if (totalIncome > 0) {
                const savingsRate = (currentBalance / totalIncome) * 100;
                score += Math.min(25, savingsRate); // Cap at 25 points
                factors++;
            }
            
            // Factor 3: Income stability (25 points) - simplified
            score += 20; // Assume moderate stability
            factors++;
            
            // Factor 4: Emergency fund (25 points)
            if (totalBudget > 0) {
                const emergencyMonths = currentBalance / totalBudget;
                score += Math.min(25, emergencyMonths * 8.33); // 3 months = 25 points
                factors++;
            }
            
            const finalScore = factors > 0 ? Math.round(score / factors * 4) : 0; // Scale to 100
            
            // Update chart
            charts.healthScore.data.datasets[0].data = [finalScore, 100 - finalScore];
            
            // Color based on score
            let color = '#ef4444'; // Red
            if (finalScore >= 70) color = '#10b981'; // Green
            else if (finalScore >= 50) color = '#f59e0b'; // Yellow
            
            charts.healthScore.data.datasets[0].backgroundColor = [color, '#e5e7eb'];
            charts.healthScore.update();
            
            // Update score display
            document.getElementById('healthScoreValue').textContent = finalScore;
            document.getElementById('healthScoreValue').style.color = color;
            
            // Update breakdown
            const breakdown = document.getElementById('healthScoreBreakdown');
            let status = 'Needs Improvement';
            if (finalScore >= 80) status = 'Excellent';
            else if (finalScore >= 60) status = 'Good';
            else if (finalScore >= 40) status = 'Fair';
            
            breakdown.innerHTML = `
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>Budget Adherence:</strong> ${totalBudget > 0 ? (actualSpending <= totalBudget ? '✅' : '⚠️') : '❓'}</p>
                <p><strong>Emergency Fund:</strong> ${currentBalance > totalBudget * 3 ? '✅' : '⚠️'}</p>
                <p><strong>Savings Rate:</strong> ${(currentBalance / Math.max(totalIncome, 1) * 100).toFixed(1)}%</p>
            `;
        }
        
        function updateSmartRecommendations(analyticsType) {
            const recommendationsElement = document.getElementById('spendingRecommendations');
            
            // Get current financial state
            const currentBalance = parseFloat(document.getElementById('currentBalance').value || 0);
            const totalIncome = parseFloat(document.getElementById('salary').value || 0) + parseFloat(document.getElementById('otherIncome').value || 0);
            
            let recommendations = '';
            
            // Budget-based recommendations
            const currentDate = new Date();
            const currentMonthTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === currentDate.getMonth() &&
                       transDate.getFullYear() === currentDate.getFullYear() &&
                       trans.category !== 'Income';
            });
            
            const actualSpending = currentMonthTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
            const totalBudget = parseFloat(document.getElementById('budgetRent').value || 0) +
                              parseFloat(document.getElementById('budgetUtilities').value || 0) +
                              parseFloat(document.getElementById('budgetGroceries').value || 0) +
                              parseFloat(document.getElementById('budgetEatingOut').value || 0) +
                              parseFloat(document.getElementById('budgetTransportation').value || 0) +
                              parseFloat(document.getElementById('budgetEntertainment').value || 0) +
                              parseFloat(document.getElementById('budgetShopping').value || 0) +
                              parseFloat(document.getElementById('budgetHobbies').value || 0) +
                              parseFloat(document.getElementById('budgetInternet').value || 0) +
                              parseFloat(document.getElementById('budgetInsurance').value || 0) +
                              parseFloat(document.getElementById('budgetMisc').value || 0) +
                              parseFloat(document.getElementById('budgetETFInvestment').value || 0);
            
            if (actualSpending > totalBudget * 1.1) {
                recommendations += '<p>💡 <strong>Budget Alert:</strong> Consider reducing spending in high-variance categories to stay within budget.</p>';
            } else if (actualSpending < totalBudget * 0.8) {
                recommendations += '<p>💰 <strong>Savings Opportunity:</strong> You\'re under budget! Consider increasing your ETF investments.</p>';
            }
            
            // Emergency fund recommendation
            if (currentBalance < totalBudget * 3) {
                recommendations += '<p>🚨 <strong>Emergency Fund:</strong> Build your emergency fund to cover 3-6 months of expenses.</p>';
            }
            
            // Savings rate recommendation
            const savingsRate = totalIncome > 0 ? (currentBalance / totalIncome * 100) : 0;
            if (savingsRate < 20) {
                recommendations += '<p>📈 <strong>Savings Rate:</strong> Aim for a 20% savings rate to build long-term wealth.</p>';
            }
            
            // Category-specific recommendations
            const categorySpending = {};
            currentMonthTransactions.forEach(trans => {
                if (!categorySpending[trans.category]) categorySpending[trans.category] = 0;
                categorySpending[trans.category] += parseFloat(trans.amount);
            });
            
            const highestCategory = Object.keys(categorySpending).reduce((a, b) => 
                categorySpending[a] > categorySpending[b] ? a : b, '');
            
            if (highestCategory && categorySpending[highestCategory] > totalBudget * 0.3) {
                recommendations += `<p>🎯 <strong>Category Focus:</strong> ${highestCategory} is your highest expense. Review for optimization opportunities.</p>`;
            }
            
            recommendationsElement.innerHTML = recommendations || '<p>✅ <strong>Good Job!</strong> Your finances look healthy. Keep up the great work!</p>';
            
            // Update savings potential
            const savingsPotential = Math.max(0, totalBudget - actualSpending);
            document.getElementById('savingsPotential').textContent = '€' + savingsPotential.toLocaleString();
            document.getElementById('savingsOpportunity').textContent = savingsPotential > 0 ? 'Budget surplus' : 'Review expenses';
            
            // Update risk assessment
            let riskLevel = '🟢 Low';
            let riskFactors = 'Stable finances';
            
            if (currentBalance < totalBudget || savingsRate < 10) {
                riskLevel = '🟡 Medium';
                riskFactors = 'Build emergency fund';
            }
            
            if (actualSpending > totalBudget * 1.2 || currentBalance < totalBudget * 0.5) {
                riskLevel = '🔴 High';
                riskFactors = 'Review spending';
            }
            
            document.getElementById('riskAssessment').textContent = riskLevel;
            document.getElementById('riskFactors').textContent = riskFactors;
        }
        
        // Analytics Export Functions
        function exportAdvancedAnalyticsReport() {
            const analyticsType = document.getElementById('analyticsType').value;
            const analysisPeriod = document.getElementById('trendsAnalysisPeriod').value;
            const categoryFocus = document.getElementById('trendsCategoryFocus').value;
            const viewType = document.getElementById('trendsViewType').value;
            
            let csv = `Advanced Analytics Report - Trends Analysis\n\n`;
            csv += `Report Generated: ${new Date().toLocaleDateString('en-GB')}\n`;
            csv += `Analysis Type: ${analyticsType}\n`;
            csv += `Period: ${analysisPeriod === 'all' ? 'All Time' : 'Last ' + analysisPeriod + ' Months'}\n`;
            csv += `Category Focus: ${categoryFocus}\n`;
            csv += `View Type: ${viewType}\n\n`;
            
            // Get trend data
            const historicalData = getHistoricalData(analysisPeriod, categoryFocus, viewType);
            
            csv += `TREND SUMMARY\n`;
            if (historicalData.values.length > 0) {
                const average = historicalData.values.reduce((sum, val) => sum + val, 0) / historicalData.values.length;
                const maxValue = Math.max(...historicalData.values);
                const minValue = Math.min(...historicalData.values);
                const first = historicalData.values[0];
                const last = historicalData.values[historicalData.values.length - 1];
                const changePercent = first !== 0 ? ((last - first) / first * 100) : 0;
                
                csv += `Average: €${average.toFixed(2)}\n`;
                csv += `Peak Value: €${maxValue.toFixed(2)}\n`;
                csv += `Lowest Value: €${minValue.toFixed(2)}\n`;
                csv += `Trend Change: ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%\n\n`;
                
                csv += `MONTHLY DATA\n`;
                csv += `Month,Value (€)\n`;
                historicalData.labels.forEach((label, index) => {
                    csv += `${label},€${historicalData.values[index].toFixed(2)}\n`;
                });
            } else {
                csv += `No data available for the selected period and category.\n`;
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trends_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function exportForecastingReport() {
            const forecastPeriod = document.getElementById('forecastPeriod').value;
            
            let csv = `Forecasting Report - Predictive Analytics\n\n`;
            csv += `Report Generated: ${new Date().toLocaleDateString('en-GB')}\n`;
            csv += `Forecast Period: Next ${forecastPeriod} Month(s)\n\n`;
            
            // Get forecasting data (simplified version)
            const historicalData = getHistoricalData(6, 'all', 'spending');
            
            if (historicalData.values.length >= 3) {
                const values = historicalData.values;
                const n = values.length;
                const sumX = (n * (n + 1)) / 2;
                const sumY = values.reduce((sum, val) => sum + val, 0);
                const sumXY = values.reduce((sum, val, index) => sum + val * (index + 1), 0);
                const sumX2 = (n * (n + 1) * (2 * n + 1)) / 6;
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                csv += `FORECAST SUMMARY\n`;
                csv += `Historical Data Points: ${n}\n`;
                csv += `Trend Slope: ${slope.toFixed(2)}\n`;
                csv += `Base Value: €${intercept.toFixed(2)}\n\n`;
                
                csv += `PREDICTIONS\n`;
                csv += `Month,Predicted Value (€)\n`;
                
                for (let i = 1; i <= parseInt(forecastPeriod); i++) {
                    const predicted = Math.max(0, slope * (n + i) + intercept);
                    const futureDate = new Date();
                    futureDate.setMonth(futureDate.getMonth() + i);
                    const monthLabel = futureDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                    csv += `${monthLabel},€${predicted.toFixed(2)}\n`;
                }
            } else {
                csv += `Insufficient data for forecasting. Need at least 3 months of historical data.\n`;
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `forecast_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function exportHealthScoreReport() {
            let csv = `Financial Health Score Report\n\n`;
            csv += `Report Generated: ${new Date().toLocaleDateString('en-GB')}\n\n`;
            
            // Get current values for health calculation
            const currentBalance = parseFloat(document.getElementById('currentBalance').value || 0);
            const totalIncome = parseFloat(document.getElementById('salary').value || 0) + parseFloat(document.getElementById('otherIncome').value || 0);
            
            // Calculate budget total
            const totalBudget = parseFloat(document.getElementById('budgetRent').value || 0) +
                              parseFloat(document.getElementById('budgetUtilities').value || 0) +
                              parseFloat(document.getElementById('budgetGroceries').value || 0) +
                              parseFloat(document.getElementById('budgetEatingOut').value || 0) +
                              parseFloat(document.getElementById('budgetTransportation').value || 0) +
                              parseFloat(document.getElementById('budgetEntertainment').value || 0) +
                              parseFloat(document.getElementById('budgetShopping').value || 0) +
                              parseFloat(document.getElementById('budgetHobbies').value || 0) +
                              parseFloat(document.getElementById('budgetInternet').value || 0) +
                              parseFloat(document.getElementById('budgetInsurance').value || 0) +
                              parseFloat(document.getElementById('budgetMisc').value || 0) +
                              parseFloat(document.getElementById('budgetETFInvestment').value || 0);
            
            // Calculate current month spending
            const currentDate = new Date();
            const currentMonthTransactions = transactions.filter(trans => {
                const transDate = new Date(trans.date);
                return transDate.getMonth() === currentDate.getMonth() &&
                       transDate.getFullYear() === currentDate.getFullYear() &&
                       trans.category !== 'Income';
            });
            const actualSpending = currentMonthTransactions.reduce((sum, trans) => sum + parseFloat(trans.amount), 0);
            
            csv += `FINANCIAL HEALTH OVERVIEW\n`;
            csv += `Current Balance: €${currentBalance.toFixed(2)}\n`;
            csv += `Monthly Income: €${totalIncome.toFixed(2)}\n`;
            csv += `Monthly Budget: €${totalBudget.toFixed(2)}\n`;
            csv += `Actual Spending: €${actualSpending.toFixed(2)}\n\n`;
            
            csv += `KEY METRICS\n`;
            const savingsRate = totalIncome > 0 ? (currentBalance / totalIncome * 100) : 0;
            const emergencyFundMonths = totalBudget > 0 ? (currentBalance / totalBudget) : 0;
            const budgetVariance = totalBudget > 0 ? ((actualSpending - totalBudget) / totalBudget * 100) : 0;
            
            csv += `Savings Rate: ${savingsRate.toFixed(1)}%\n`;
            csv += `Emergency Fund Coverage: ${emergencyFundMonths.toFixed(1)} months\n`;
            csv += `Budget Variance: ${budgetVariance >= 0 ? '+' : ''}${budgetVariance.toFixed(1)}%\n\n`;
            
            csv += `HEALTH ASSESSMENT\n`;
            csv += `Budget Adherence: ${actualSpending <= totalBudget ? 'Good' : 'Needs Improvement'}\n`;
            csv += `Emergency Fund: ${currentBalance > totalBudget * 3 ? 'Adequate' : 'Below Recommended'}\n`;
            csv += `Savings Rate: ${savingsRate >= 20 ? 'Excellent' : savingsRate >= 10 ? 'Good' : 'Needs Improvement'}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health_score_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function exportFullAnalyticsReport() {
            let csv = `Complete Financial Analytics Report\n\n`;
            csv += `Report Generated: ${new Date().toLocaleDateString('en-GB')}\n`;
            csv += `Financial Tracker v2.2\n\n`;
            
            // Get all analysis data
            const analysisPeriod = document.getElementById('trendsAnalysisPeriod').value;
            const categoryFocus = document.getElementById('trendsCategoryFocus').value;
            const viewType = document.getElementById('trendsViewType').value;
            const historicalData = getHistoricalData(analysisPeriod, categoryFocus, viewType);
            
            csv += `REPORT CONFIGURATION\n`;
            csv += `Analysis Period: ${analysisPeriod === 'all' ? 'All Time' : 'Last ' + analysisPeriod + ' Months'}\n`;
            csv += `Category Focus: ${categoryFocus}\n`;
            csv += `View Type: ${viewType}\n\n`;
            
            // Historical trends section
            csv += `=== HISTORICAL TRENDS ===\n`;
            if (historicalData.values.length > 0) {
                const average = historicalData.values.reduce((sum, val) => sum + val, 0) / historicalData.values.length;
                const maxValue = Math.max(...historicalData.values);
                const minValue = Math.min(...historicalData.values);
                const first = historicalData.values[0];
                const last = historicalData.values[historicalData.values.length - 1];
                const changePercent = first !== 0 ? ((last - first) / first * 100) : 0;
                
                csv += `Average: €${average.toFixed(2)}\n`;
                csv += `Peak Value: €${maxValue.toFixed(2)}\n`;
                csv += `Lowest Value: €${minValue.toFixed(2)}\n`;
                csv += `Overall Change: ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%\n\n`;
            }
            
            // Financial health section
            csv += `=== FINANCIAL HEALTH ===\n`;
            const currentBalance = parseFloat(document.getElementById('currentBalance').value || 0);
            const totalIncome = parseFloat(document.getElementById('salary').value || 0) + parseFloat(document.getElementById('otherIncome').value || 0);
            const savingsRate = totalIncome > 0 ? (currentBalance / totalIncome * 100) : 0;
            
            csv += `Current Balance: €${currentBalance.toFixed(2)}\n`;
            csv += `Monthly Income: €${totalIncome.toFixed(2)}\n`;
            csv += `Savings Rate: ${savingsRate.toFixed(1)}%\n\n`;
            
            // Recent transactions summary
            csv += `=== RECENT ACTIVITY ===\n`;
            const recentTransactions = transactions.slice(-10).reverse();
            csv += `Last 10 Transactions:\n`;
            csv += `Date,Description,Category,Amount\n`;
            recentTransactions.forEach(trans => {
                const dateObj = new Date(trans.date);
                const formattedDate = dateObj.toLocaleDateString('en-GB');
                csv += `${formattedDate},${trans.desc},${trans.category},€${trans.amount}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `complete_analytics_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // ETF Transaction Functions
        function addETFTransaction() {
            const date = document.getElementById('etfDate').value;
            const value = parseFloat(document.getElementById('etfValue').value) || 0;
            const notes = document.getElementById('etfNotes').value;
            
            if (!date || value === 0) {
                alert('Please fill in the date and portfolio value');
                return;
            }
            
            const etfTransaction = { date, value, notes };
            etfTransactions.push(etfTransaction);
            
            // Sort by date (newest first)
            etfTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            displayETFTransactions();
            saveData(true);
            
            // Clear inputs
            document.getElementById('etfValue').value = '';
            document.getElementById('etfNotes').value = '';
        }
        
        function displayETFTransactions() {
            const tbody = document.getElementById('etfTransactionList');
            tbody.innerHTML = '';
            
            if (etfTransactions.length === 0) {
                return;
            }
            
            // Calculate totals and growth
            const latestValue = etfTransactions[0].value;
            const firstValue = etfTransactions[etfTransactions.length - 1].value;
            const totalGrowth = latestValue - firstValue;
            const overallGrowthRate = firstValue > 0 ? ((totalGrowth / firstValue) * 100) : 0;
            
            // Update summary display
            document.getElementById('etfEntryCount').textContent = etfTransactions.length;
            document.getElementById('latestETFValue').textContent = '€' + latestValue.toFixed(2);
            document.getElementById('totalETFGrowth').textContent = totalGrowth >= 0 ? '+€' + totalGrowth.toFixed(2) : '€' + totalGrowth.toFixed(2);
            document.getElementById('totalETFGrowth').className = totalGrowth >= 0 ? 'positive' : 'negative';
            document.getElementById('overallGrowthRate').textContent = overallGrowthRate.toFixed(2) + '%';
            document.getElementById('overallGrowthRate').className = overallGrowthRate >= 0 ? 'positive' : 'negative';
            
            etfTransactions.forEach((etf, index) => {
                const dateObj = new Date(etf.date);
                const formattedDate = dateObj.toLocaleDateString('en-GB');
                
                // Calculate change from previous entry
                let change = 0;
                let growthRate = 0;
                if (index < etfTransactions.length - 1) {
                    const previousValue = etfTransactions[index + 1].value;
                    change = etf.value - previousValue;
                    growthRate = previousValue > 0 ? ((change / previousValue) * 100) : 0;
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">€${etf.value.toFixed(2)}</td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}€${change.toFixed(2)}</td>
                    <td class="${growthRate >= 0 ? 'positive' : 'negative'}">${growthRate >= 0 ? '+' : ''}${growthRate.toFixed(2)}%</td>
                    <td>${etf.notes || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeETFTransaction(${index})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                    </td>
                `;
            });
            
            // Update portfolio value in monthly budget
            document.getElementById('currentTotalPortfolio').value = latestValue.toFixed(2);
            
            // Calculate and update monthly growth rate
            updateMonthlyGrowthRate();
        }
        
        function removeETFTransaction(index) {
            etfTransactions.splice(index, 1);
            displayETFTransactions();
            saveData(true);
        }
        
        function updateMonthlyGrowthRate() {
            if (etfTransactions.length < 2) {
                document.getElementById('monthlyGrowthRate').value = '0.00';
                return;
            }
            
            // Find entries from last month and current month
            const currentDate = new Date();
            const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, currentDate.getDate());
            
            let currentMonthValue = 0;
            let lastMonthValue = 0;
            
            etfTransactions.forEach(etf => {
                const etfDate = new Date(etf.date);
                if (etfDate.getMonth() === currentDate.getMonth() && etfDate.getFullYear() === currentDate.getFullYear()) {
                    currentMonthValue = etf.value;
                } else if (etfDate.getMonth() === lastMonth.getMonth() && etfDate.getFullYear() === lastMonth.getFullYear()) {
                    lastMonthValue = etf.value;
                }
            });
            
            if (lastMonthValue > 0 && currentMonthValue > 0) {
                const monthlyGrowth = ((currentMonthValue - lastMonthValue) / lastMonthValue) * 100;
                document.getElementById('monthlyGrowthRate').value = monthlyGrowth.toFixed(2);
            } else {
                document.getElementById('monthlyGrowthRate').value = '0.00';
            }
        }
    </script>
</body>
</html>