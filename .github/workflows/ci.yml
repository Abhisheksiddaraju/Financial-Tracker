name: CI - Financial Tracker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  basic-checks:
    name: Basic Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "📁 Checking file structure..."
        
        # Check if main files exist
        if [ -f "financial-tracker.html" ]; then
          echo "✅ financial-tracker.html exists"
          
          # Get file size using wc (more portable than stat)
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "📊 HTML file size: ${HTML_SIZE} bytes"
          
          if [ $HTML_SIZE -gt 500000 ]; then
            echo "⚠️  HTML file is large: ${HTML_SIZE} bytes"
          else
            echo "✅ HTML file size is reasonable: ${HTML_SIZE} bytes"
          fi
        else
          echo "❌ financial-tracker.html not found"
          exit 1
        fi
        
        # Check documentation files
        docs=("README.md" "LICENSE" "CHANGELOG.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md")
        for doc in "${docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "✅ $doc exists"
          else
            echo "❌ $doc missing"
            exit 1
          fi
        done
        
        # Check GitHub files
        if [ -f ".github/workflows/ci.yml" ]; then
          echo "✅ GitHub Actions workflow exists"
        else
          echo "❌ GitHub Actions workflow missing"
          exit 1
        fi
        
        if [ -d ".github/ISSUE_TEMPLATE" ]; then
          echo "✅ Issue templates directory exists"
        else
          echo "❌ Issue templates directory missing"
          exit 1
        fi
        
        if [ -f ".github/pull_request_template.md" ]; then
          echo "✅ Pull request template exists"
        else
          echo "❌ Pull request template missing"
          exit 1
        fi
        
        # Count total files
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "📊 Total files in repository: ${TOTAL_FILES}"
        
        echo ""
        echo "🎉 File structure check completed successfully!"
        
    - name: Check HTML content
      run: |
        echo "🔍 Checking HTML content..."
        
        # Check for essential HTML elements
        if grep -q "<!DOCTYPE html>" financial-tracker.html; then
          echo "✅ DOCTYPE declaration found"
        else
          echo "❌ DOCTYPE declaration missing"
        fi
        
        if grep -q "<html" financial-tracker.html; then
          echo "✅ HTML tag found"
        else
          echo "❌ HTML tag missing"
        fi
        
        if grep -q "<head" financial-tracker.html; then
          echo "✅ Head section found"
        else
          echo "❌ Head section missing"
        fi
        
        if grep -q "<body" financial-tracker.html; then
          echo "✅ Body section found"
        else
          echo "❌ Body section missing"
        fi
        
        if grep -q "<script" financial-tracker.html; then
          echo "✅ JavaScript found"
        else
          echo "❌ JavaScript missing"
        fi
        
        if grep -q "<style" financial-tracker.html; then
          echo "✅ CSS found"
        else
          echo "❌ CSS missing"
        fi
        
        # Check for Chart.js integration
        if grep -q "Chart\.js" financial-tracker.html; then
          echo "✅ Chart.js integration found"
        else
          echo "❌ Chart.js integration missing"
        fi
        
        # Check for localStorage usage
        if grep -q "localStorage" financial-tracker.html; then
          echo "✅ LocalStorage API usage found"
        else
          echo "❌ LocalStorage API usage missing"
        fi
        
        echo ""
        echo "✅ HTML content validation completed!"
        
    - name: Check for sensitive data
      run: |
        echo "🔒 Checking for sensitive data..."
        
        # Check for actual sensitive data patterns (not comments)
        # Look for patterns that indicate real credentials, not just the words
        SENSITIVE_FOUND=false
        
        # Check for actual API keys (not just the word "api_key")
        if grep -r "sk_[a-zA-Z0-9]{24,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential Stripe secret key found"
          SENSITIVE_FOUND=true
        fi
        
        if grep -r "pk_[a-zA-Z0-9]{24,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential Stripe publishable key found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual passwords (not just the word "password")
        if grep -r "password.*=.*['\"][^'\"]{8,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential hardcoded password found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual tokens (not just the word "token")
        if grep -r "token.*=.*['\"][a-zA-Z0-9]{32,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential hardcoded token found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual secrets (not just the word "secret")
        if grep -r "secret.*=.*['\"][a-zA-Z0-9]{16,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential hardcoded secret found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual API keys (not just the word "api_key")
        if grep -r "api_key.*=.*['\"][a-zA-Z0-9]{16,}" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠️  Potential hardcoded API key found"
          SENSITIVE_FOUND=true
        fi
        
        if [ "$SENSITIVE_FOUND" = true ]; then
          echo "❌ Sensitive data found - please review and remove"
          exit 1
        else
          echo "✅ No sensitive data found"
        fi
        
    - name: Check responsive design
      run: |
        echo "📱 Checking responsive design..."
        
        # Check for responsive CSS
        if grep -q "@media" financial-tracker.html; then
          echo "✅ Responsive design found"
        else
          echo "⚠️  Limited responsive design"
        fi
        
        if grep -q "grid-template-columns" financial-tracker.html; then
          echo "✅ CSS Grid usage found"
        else
          echo "⚠️  Limited CSS Grid usage"
        fi
        
        if grep -q "flexbox\|flex" financial-tracker.html; then
          echo "✅ Flexbox usage found"
        else
          echo "⚠️  Limited Flexbox usage"
        fi
        
    - name: Generate final report
      run: |
        echo ""
        echo "🎉 Financial Tracker CI Complete!"
        echo "📊 All basic quality checks passed"
        echo "🚀 Ready for deployment"
        
        # Show project stats
        echo ""
        echo "📁 Project Statistics:"
        if [ -f "financial-tracker.html" ]; then
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "- HTML file: ${HTML_SIZE} bytes"
        fi
        
        MD_COUNT=$(find . -name "*.md" | wc -l)
        echo "- Documentation: ${MD_COUNT} markdown files"
        
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "- Total files: ${TOTAL_FILES}"
        
        echo ""
        echo "✅ All quality checks passed!"
