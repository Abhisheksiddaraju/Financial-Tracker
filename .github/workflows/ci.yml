name: CI - Financial Tracker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  basic-checks:
    name: Basic Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "ğŸ“ Checking file structure..."
        
        # Check if main files exist
        if [ -f "financial-tracker.html" ]; then
          echo "âœ… financial-tracker.html exists"
          
          # Get file size using wc (more portable than stat)
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "ğŸ“Š HTML file size: ${HTML_SIZE} bytes"
          
          if [ $HTML_SIZE -gt 500000 ]; then
            echo "âš ï¸  HTML file is large: ${HTML_SIZE} bytes"
          else
            echo "âœ… HTML file size is reasonable: ${HTML_SIZE} bytes"
          fi
        else
          echo "âŒ financial-tracker.html not found"
          exit 1
        fi
        
        # Check documentation files
        docs=("README.md" "LICENSE" "CHANGELOG.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md")
        for doc in "${docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc exists"
          else
            echo "âŒ $doc missing"
            exit 1
          fi
        done
        
        # Check GitHub files
        if [ -f ".github/workflows/ci.yml" ]; then
          echo "âœ… GitHub Actions workflow exists"
        else
          echo "âŒ GitHub Actions workflow missing"
          exit 1
        fi
        
        if [ -d ".github/ISSUE_TEMPLATE" ]; then
          echo "âœ… Issue templates directory exists"
        else
          echo "âŒ Issue templates directory missing"
          exit 1
        fi
        
        if [ -f ".github/pull_request_template.md" ]; then
          echo "âœ… Pull request template exists"
        else
          echo "âŒ Pull request template missing"
          exit 1
        fi
        
        # Count total files
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "ğŸ“Š Total files in repository: ${TOTAL_FILES}"
        
        echo ""
        echo "ğŸ‰ File structure check completed successfully!"
        
    - name: Check HTML content
      run: |
        echo "ğŸ” Checking HTML content..."
        
        # Check for essential HTML elements
        if grep -q "<!DOCTYPE html>" financial-tracker.html; then
          echo "âœ… DOCTYPE declaration found"
        else
          echo "âŒ DOCTYPE declaration missing"
        fi
        
        if grep -q "<html" financial-tracker.html; then
          echo "âœ… HTML tag found"
        else
          echo "âŒ HTML tag missing"
        fi
        
        if grep -q "<head" financial-tracker.html; then
          echo "âœ… Head section found"
        else
          echo "âŒ Head section missing"
        fi
        
        if grep -q "<body" financial-tracker.html; then
          echo "âœ… Body section found"
        else
          echo "âŒ Body section missing"
        fi
        
        if grep -q "<script" financial-tracker.html; then
          echo "âœ… JavaScript found"
        else
          echo "âŒ JavaScript missing"
        fi
        
        if grep -q "<style" financial-tracker.html; then
          echo "âœ… CSS found"
        else
          echo "âŒ CSS missing"
        fi
        
        # Check for Chart.js integration
        if grep -q "Chart\.js" financial-tracker.html; then
          echo "âœ… Chart.js integration found"
        else
          echo "âŒ Chart.js integration missing"
        fi
        
        # Check for localStorage usage
        if grep -q "localStorage" financial-tracker.html; then
          echo "âœ… LocalStorage API usage found"
        else
          echo "âŒ LocalStorage API usage missing"
        fi
        
        echo ""
        echo "âœ… HTML content validation completed!"
        
    - name: Check for sensitive data
      run: |
        echo "ğŸ”’ Checking for sensitive data..."
        
        # Check for actual sensitive data patterns (not comments)
        # Look for patterns that indicate real credentials, not just the words
        SENSITIVE_FOUND=false
        
        # Check for actual API keys (not just the word "api_key")
        if grep -r "sk_[a-zA-Z0-9]{24,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential Stripe secret key found"
          SENSITIVE_FOUND=true
        fi
        
        if grep -r "pk_[a-zA-Z0-9]{24,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential Stripe publishable key found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual passwords (not just the word "password")
        if grep -r "password.*=.*['\"][^'\"]{8,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential hardcoded password found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual tokens (not just the word "token")
        if grep -r "token.*=.*['\"][a-zA-Z0-9]{32,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential hardcoded token found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual secrets (not just the word "secret")
        if grep -r "secret.*=.*['\"][a-zA-Z0-9]{16,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential hardcoded secret found"
          SENSITIVE_FOUND=true
        fi
        
        # Check for actual API keys (not just the word "api_key")
        if grep -r "api_key.*=.*['\"][a-zA-Z0-9]{16,}" . --exclude-dir=.git 2>/dev/null; then
          echo "âš ï¸  Potential hardcoded API key found"
          SENSITIVE_FOUND=true
        fi
        
        if [ "$SENSITIVE_FOUND" = true ]; then
          echo "âŒ Sensitive data found - please review and remove"
          exit 1
        else
          echo "âœ… No sensitive data found"
        fi
        
    - name: Check responsive design
      run: |
        echo "ğŸ“± Checking responsive design..."
        
        # Check for responsive CSS
        if grep -q "@media" financial-tracker.html; then
          echo "âœ… Responsive design found"
        else
          echo "âš ï¸  Limited responsive design"
        fi
        
        if grep -q "grid-template-columns" financial-tracker.html; then
          echo "âœ… CSS Grid usage found"
        else
          echo "âš ï¸  Limited CSS Grid usage"
        fi
        
        if grep -q "flexbox\|flex" financial-tracker.html; then
          echo "âœ… Flexbox usage found"
        else
          echo "âš ï¸  Limited Flexbox usage"
        fi
        
    - name: Generate final report
      run: |
        echo ""
        echo "ğŸ‰ Financial Tracker CI Complete!"
        echo "ğŸ“Š All basic quality checks passed"
        echo "ğŸš€ Ready for deployment"
        
        # Show project stats
        echo ""
        echo "ğŸ“ Project Statistics:"
        if [ -f "financial-tracker.html" ]; then
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "- HTML file: ${HTML_SIZE} bytes"
        fi
        
        MD_COUNT=$(find . -name "*.md" | wc -l)
        echo "- Documentation: ${MD_COUNT} markdown files"
        
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "- Total files: ${TOTAL_FILES}"
        
        echo ""
        echo "âœ… All quality checks passed!"
