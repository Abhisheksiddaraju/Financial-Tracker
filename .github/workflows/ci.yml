name: CI - Financial Tracker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  basic-checks:
    name: Basic Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "üìÅ Checking file structure..."
        
        # Check if main files exist
        if [ -f "financial-tracker.html" ]; then
          echo "‚úÖ financial-tracker.html exists"
          
          # Get file size using wc (more portable than stat)
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "üìä HTML file size: ${HTML_SIZE} bytes"
          
          if [ $HTML_SIZE -gt 500000 ]; then
            echo "‚ö†Ô∏è  HTML file is large: ${HTML_SIZE} bytes"
          else
            echo "‚úÖ HTML file size is reasonable: ${HTML_SIZE} bytes"
          fi
        else
          echo "‚ùå financial-tracker.html not found"
          exit 1
        fi
        
        # Check documentation files
        docs=("README.md" "LICENSE" "CHANGELOG.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md")
        for doc in "${docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "‚úÖ $doc exists"
          else
            echo "‚ùå $doc missing"
            exit 1
          fi
        done
        
        # Check GitHub files
        if [ -f ".github/workflows/ci.yml" ]; then
          echo "‚úÖ GitHub Actions workflow exists"
        else
          echo "‚ùå GitHub Actions workflow missing"
          exit 1
        fi
        
        if [ -d ".github/ISSUE_TEMPLATE" ]; then
          echo "‚úÖ Issue templates directory exists"
        else
          echo "‚ùå Issue templates directory missing"
          exit 1
        fi
        
        if [ -f ".github/pull_request_template.md" ]; then
          echo "‚úÖ Pull request template exists"
        else
          echo "‚ùå Pull request template missing"
          exit 1
        fi
        
        # Count total files
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "üìä Total files in repository: ${TOTAL_FILES}"
        
        echo ""
        echo "üéâ File structure check completed successfully!"
        
    - name: Check HTML content
      run: |
        echo "üîç Checking HTML content..."
        
        # Check for essential HTML elements
        if grep -q "<!DOCTYPE html>" financial-tracker.html; then
          echo "‚úÖ DOCTYPE declaration found"
        else
          echo "‚ùå DOCTYPE declaration missing"
        fi
        
        if grep -q "<html" financial-tracker.html; then
          echo "‚úÖ HTML tag found"
        else
          echo "‚ùå HTML tag missing"
        fi
        
        if grep -q "<head" financial-tracker.html; then
          echo "‚úÖ Head section found"
        else
          echo "‚ùå Head section missing"
        fi
        
        if grep -q "<body" financial-tracker.html; then
          echo "‚úÖ Body section found"
        else
          echo "‚ùå Body section missing"
        fi
        
        if grep -q "<script" financial-tracker.html; then
          echo "‚úÖ JavaScript found"
        else
          echo "‚ùå JavaScript missing"
        fi
        
        if grep -q "<style" financial-tracker.html; then
          echo "‚úÖ CSS found"
        else
          echo "‚ùå CSS missing"
        fi
        
        # Check for Chart.js integration
        if grep -q "Chart\.js" financial-tracker.html; then
          echo "‚úÖ Chart.js integration found"
        else
          echo "‚ùå Chart.js integration missing"
        fi
        
        # Check for localStorage usage
        if grep -q "localStorage" financial-tracker.html; then
          echo "‚úÖ LocalStorage API usage found"
        else
          echo "‚ùå LocalStorage API usage missing"
        fi
        
        echo ""
        echo "‚úÖ HTML content validation completed!"
        
    - name: Check for sensitive data
      run: |
        echo "üîí Checking for sensitive data..."
        
        # Check for actual sensitive data patterns (not comments or workflow files)
        # Look for patterns that indicate real credentials, not just the words
        SENSITIVE_FOUND=false
        
        # Only check the main HTML file for sensitive data, not workflow files
        if [ -f "financial-tracker.html" ]; then
          echo "üîç Scanning financial-tracker.html for sensitive data..."
          
          # Check for actual API keys (not just the word "api_key")
          if grep -q "sk_[a-zA-Z0-9]\{24,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential Stripe secret key found"
            SENSITIVE_FOUND=true
          fi
          
          if grep -q "pk_[a-zA-Z0-9]\{24,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential Stripe publishable key found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for actual passwords (not just the word "password")
          if grep -q "password.*=.*['\"][^'\"]\{8,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential hardcoded password found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for actual tokens (not just the word "token")
          if grep -q "token.*=.*['\"][a-zA-Z0-9]\{32,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential hardcoded token found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for actual secrets (not just the word "secret")
          if grep -q "secret.*=.*['\"][a-zA-Z0-9]\{16,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential hardcoded secret found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for actual API keys (not just the word "api_key")
          if grep -q "api_key.*=.*['\"][a-zA-Z0-9]\{16,\}" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential hardcoded API key found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for hardcoded database credentials
          if grep -q "mysql://\|postgresql://\|mongodb://" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential database connection string found"
            SENSITIVE_FOUND=true
          fi
          
          # Check for hardcoded URLs with credentials
          if grep -q "https://[^:]*:[^@]*@" financial-tracker.html; then
            echo "‚ö†Ô∏è  Potential URL with embedded credentials found"
            SENSITIVE_FOUND=true
          fi
        else
          echo "‚ùå financial-tracker.html not found - skipping sensitive data check"
        fi
        
        if [ "$SENSITIVE_FOUND" = true ]; then
          echo "‚ùå Sensitive data found - please review and remove"
          exit 1
        else
          echo "‚úÖ No sensitive data found"
        fi
        
    - name: Check responsive design
      run: |
        echo "üì± Checking responsive design..."
        
        # Check for responsive CSS
        if grep -q "@media" financial-tracker.html; then
          echo "‚úÖ Responsive design found"
        else
          echo "‚ö†Ô∏è  Limited responsive design"
        fi
        
        if grep -q "grid-template-columns" financial-tracker.html; then
          echo "‚úÖ CSS Grid usage found"
        else
          echo "‚ö†Ô∏è  Limited CSS Grid usage"
        fi
        
        if grep -q "flexbox\|flex" financial-tracker.html; then
          echo "‚úÖ Flexbox usage found"
        else
          echo "‚ö†Ô∏è  Limited Flexbox usage"
        fi
        
    - name: Generate final report
      run: |
        echo ""
        echo "üéâ Financial Tracker CI Complete!"
        echo "üìä All basic quality checks passed"
        echo "üöÄ Ready for deployment"
        
        # Show project stats
        echo ""
        echo "üìÅ Project Statistics:"
        if [ -f "financial-tracker.html" ]; then
          HTML_SIZE=$(wc -c < financial-tracker.html)
          echo "- HTML file: ${HTML_SIZE} bytes"
        fi
        
        MD_COUNT=$(find . -name "*.md" | wc -l)
        echo "- Documentation: ${MD_COUNT} markdown files"
        
        TOTAL_FILES=$(find . -type f | wc -l)
        echo "- Total files: ${TOTAL_FILES}"
        
        echo ""
        echo "‚úÖ All quality checks passed!"
